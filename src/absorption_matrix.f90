!
MODULE ABSORPTION_MATRIX
  !
  !================================================
  !
  ! May 20, 2014
  ! KIS, Freiburg
  !
  USE CONS_PARAM, ONLY: DPI, KBOL, LIGHT, MAMU, SP, DP
  USE DERIVVAR
  USE FORWARD_PARAM, ONLY: PIXEL_INI,PIXEL_END, KLIN &
      , NUMWAVE, NUMW, LINE_ZN, LINE_L0, WAVE, KC
  USE ATM_PARAM
  USE MAGSPLIT, ONLY: TYPE_SC, STRENGTH_SC, LAMBDA_SC &
      , NTOT, ZEEMAN_COMP
  USE CODE_MODES, ONLY: MRESPFUNCT
  USE ALLOCATE_UTILS, ONLY: ALLOCATE_1D_DP
  !
  IMPLICIT NONE
  !
  !::::::::::::::::::::::::::::::::::::::::::::::::
  !
  PUBLIC :: ABS_MAT_INIT
  PUBLIC :: GET_ABS_MAT
  PUBLIC :: ABS_MAT_END
  !
  PRIVATE :: ABS_MAT_FIRST_STEP
  PRIVATE :: ABS_MAT_END_STEP
  PRIVATE :: GET_ABS_MAT_WODEV
  PRIVATE :: GET_ABS_MAT_WDEV
  !
  REAL(DP), ALLOCATABLE, PUBLIC :: ETAI(:), ETAQ(:), ETAU(:), ETAV(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: RHOQ(:), RHOU(:), RHOV(:)
  !
  REAL(DP), ALLOCATABLE, PRIVATE :: IETAI(:), IETAQ(:), IETAU(:), IETAV(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: IRHOQ(:), IRHOU(:), IRHOV(:)
  !
  REAL(DP), ALLOCATABLE, PUBLIC :: DETAI_DBX(:), DETAQ_DBX(:), DETAU_DBX(:), DETAV_DBX(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DRHOQ_DBX(:), DRHOU_DBX(:), DRHOV_DBX(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DETAI_DBY(:), DETAQ_DBY(:), DETAU_DBY(:), DETAV_DBY(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DRHOQ_DBY(:), DRHOU_DBY(:), DRHOV_DBY(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DETAI_DBZ(:), DETAQ_DBZ(:), DETAU_DBZ(:), DETAV_DBZ(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DRHOQ_DBZ(:), DRHOU_DBZ(:), DRHOV_DBZ(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DETAI_DVLOS(:), DETAQ_DVLOS(:), DETAU_DVLOS(:), DETAV_DVLOS(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DRHOQ_DVLOS(:), DRHOU_DVLOS(:), DRHOV_DVLOS(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DETAI_DTPG(:), DETAQ_DTPG(:), DETAU_DTPG(:), DETAV_DTPG(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DRHOQ_DTPG(:), DRHOU_DTPG(:), DRHOV_DTPG(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DETAI_DTRHO(:), DETAQ_DTRHO(:), DETAU_DTRHO(:), DETAV_DTRHO(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DRHOQ_DTRHO(:), DRHOU_DTRHO(:), DRHOV_DTRHO(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DETAI_DPGT(:), DETAQ_DPGT(:), DETAU_DPGT(:), DETAV_DPGT(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DRHOQ_DPGT(:), DRHOU_DPGT(:), DRHOV_DPGT(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DETAI_DRHOT(:), DETAQ_DRHOT(:), DETAU_DRHOT(:), DETAV_DRHOT(:)
  REAL(DP), ALLOCATABLE, PUBLIC :: DRHOQ_DRHOT(:), DRHOU_DRHOT(:), DRHOV_DRHOT(:)
  !
  REAL(DP), ALLOCATABLE, PRIVATE :: DIETAI_DBX(:), DIETAQ_DBX(:), DIETAU_DBX(:), DIETAV_DBX(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIRHOQ_DBX(:), DIRHOU_DBX(:), DIRHOV_DBX(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIETAI_DBY(:), DIETAQ_DBY(:), DIETAU_DBY(:), DIETAV_DBY(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIRHOQ_DBY(:), DIRHOU_DBY(:), DIRHOV_DBY(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIETAI_DBZ(:), DIETAQ_DBZ(:), DIETAU_DBZ(:), DIETAV_DBZ(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIRHOQ_DBZ(:), DIRHOU_DBZ(:), DIRHOV_DBZ(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIETAI_DVLOS(:), DIETAQ_DVLOS(:), DIETAU_DVLOS(:), DIETAV_DVLOS(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIRHOQ_DVLOS(:), DIRHOU_DVLOS(:), DIRHOV_DVLOS(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIETAI_DTPG(:), DIETAQ_DTPG(:), DIETAU_DTPG(:), DIETAV_DTPG(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIRHOQ_DTPG(:), DIRHOU_DTPG(:), DIRHOV_DTPG(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIETAI_DTRHO(:), DIETAQ_DTRHO(:), DIETAU_DTRHO(:), DIETAV_DTRHO(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIRHOQ_DTRHO(:), DIRHOU_DTRHO(:), DIRHOV_DTRHO(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIETAI_DPGT(:), DIETAQ_DPGT(:), DIETAU_DPGT(:), DIETAV_DPGT(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIRHOQ_DPGT(:), DIRHOU_DPGT(:), DIRHOV_DPGT(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIETAI_DRHOT(:), DIETAQ_DRHOT(:), DIETAU_DRHOT(:), DIETAV_DRHOT(:)
  REAL(DP), ALLOCATABLE, PRIVATE :: DIRHOQ_DRHOT(:), DIRHOU_DRHOT(:), DIRHOV_DRHOT(:)
  !
  PRIVATE
  !
  !************************************************
  !
  CONTAINS
  !
  ! abs_mat_init
  ! get_abs_mat
  ! abs_mat_first_step
  ! get_abs_mat_wodev
  ! get_abs_mat_wdev
  !
  !------------------------------------------------
  !
  SUBROUTINE ABS_MAT_INIT
    !
    !CALL ALLOCATE_2D_DP(PROF,7,NUMW,'PROF')
    CALL ALLOCATE_1D_DP(ETAI,NUMW,'ETAI')
    CALL ALLOCATE_1D_DP(ETAQ,NUMW,'ETAQ')
    CALL ALLOCATE_1D_DP(ETAU,NUMW,'ETAU')
    CALL ALLOCATE_1D_DP(ETAV,NUMW,'ETAV')
    CALL ALLOCATE_1D_DP(RHOQ,NUMW,'RHOQ')
    CALL ALLOCATE_1D_DP(RHOU,NUMW,'RHOU')
    CALL ALLOCATE_1D_DP(RHOV,NUMW,'RHOV')
    !
    CALL ALLOCATE_1D_DP(IETAI,NUMW,'IETAI')
    CALL ALLOCATE_1D_DP(IETAQ,NUMW,'IETAQ')
    CALL ALLOCATE_1D_DP(IETAU,NUMW,'IETAU')
    CALL ALLOCATE_1D_DP(IETAV,NUMW,'IETAV')
    CALL ALLOCATE_1D_DP(IRHOQ,NUMW,'IRHOQ')
    CALL ALLOCATE_1D_DP(IRHOU,NUMW,'IRHOU')
    CALL ALLOCATE_1D_DP(IRHOV,NUMW,'IRHOV')
    !
    IF (MRESPFUNCT.EQV..TRUE.) THEN
      !DERIVATIVES:
      !
      ! Dbx
      !
      CALL ALLOCATE_1D_DP(DETAI_DBX,NUMW,'DETAI_DBX')
      CALL ALLOCATE_1D_DP(DETAQ_DBX,NUMW,'DETAQ_DBX')
      CALL ALLOCATE_1D_DP(DETAU_DBX,NUMW,'DETAU_DBX')
      CALL ALLOCATE_1D_DP(DETAV_DBX,NUMW,'DETAV_DBX')
      CALL ALLOCATE_1D_DP(DRHOQ_DBX,NUMW,'DRHOQ_DBX')
      CALL ALLOCATE_1D_DP(DRHOU_DBX,NUMW,'DRHOU_DBX')
      CALL ALLOCATE_1D_DP(DRHOV_DBX,NUMW,'DRHOV_DBX')
      !
      ! Dby
      !
      CALL ALLOCATE_1D_DP(DETAI_DBY,NUMW,'DETAI_DBY')
      CALL ALLOCATE_1D_DP(DETAQ_DBY,NUMW,'DETAQ_DBY')
      CALL ALLOCATE_1D_DP(DETAU_DBY,NUMW,'DETAU_DBY')
      CALL ALLOCATE_1D_DP(DETAV_DBY,NUMW,'DETAV_DBY')
      CALL ALLOCATE_1D_DP(DRHOQ_DBY,NUMW,'DRHOQ_DBY')
      CALL ALLOCATE_1D_DP(DRHOU_DBY,NUMW,'DRHOU_DBY')
      CALL ALLOCATE_1D_DP(DRHOV_DBY,NUMW,'DRHOV_DBY')
      !
      ! Dbz
      !
      CALL ALLOCATE_1D_DP(DETAI_DBZ,NUMW,'DETAI_DBZ')
      CALL ALLOCATE_1D_DP(DETAQ_DBZ,NUMW,'DETAQ_DBZ')
      CALL ALLOCATE_1D_DP(DETAU_DBZ,NUMW,'DETAU_DBZ')
      CALL ALLOCATE_1D_DP(DETAV_DBZ,NUMW,'DETAV_DBZ')
      CALL ALLOCATE_1D_DP(DRHOQ_DBZ,NUMW,'DRHOQ_DBZ')
      CALL ALLOCATE_1D_DP(DRHOU_DBZ,NUMW,'DRHOU_DBZ')
      CALL ALLOCATE_1D_DP(DRHOV_DBZ,NUMW,'DRHOV_DBZ')
      !
      ! Dvlos
      !
      CALL ALLOCATE_1D_DP(DETAI_DVLOS,NUMW,'DETAI_DVLOS')
      CALL ALLOCATE_1D_DP(DETAQ_DVLOS,NUMW,'DETAQ_DVLOS')
      CALL ALLOCATE_1D_DP(DETAU_DVLOS,NUMW,'DETAU_DVLOS')
      CALL ALLOCATE_1D_DP(DETAV_DVLOS,NUMW,'DETAV_DVLOS')
      CALL ALLOCATE_1D_DP(DRHOQ_DVLOS,NUMW,'DRHOQ_DVLOS')
      CALL ALLOCATE_1D_DP(DRHOU_DVLOS,NUMW,'DRHOU_DVLOS')
      CALL ALLOCATE_1D_DP(DRHOV_DVLOS,NUMW,'DRHOV_DVLOS')
      !
      ! Dt at constant PG
      !
      CALL ALLOCATE_1D_DP(DETAI_DTPG,NUMW,'DETAI_DTPG')
      CALL ALLOCATE_1D_DP(DETAQ_DTPG,NUMW,'DETAQ_DTPG')
      CALL ALLOCATE_1D_DP(DETAU_DTPG,NUMW,'DETAU_DTPG')
      CALL ALLOCATE_1D_DP(DETAV_DTPG,NUMW,'DETAV_DTPG')
      CALL ALLOCATE_1D_DP(DRHOQ_DTPG,NUMW,'DRHOQ_DTPG')
      CALL ALLOCATE_1D_DP(DRHOU_DTPG,NUMW,'DRHOU_DTPG')
      CALL ALLOCATE_1D_DP(DRHOV_DTPG,NUMW,'DRHOV_DTPG')
      !
      ! Dt at constant RHO
      !
      CALL ALLOCATE_1D_DP(DETAI_DTRHO,NUMW,'DETAI_DTRHO')
      CALL ALLOCATE_1D_DP(DETAQ_DTRHO,NUMW,'DETAQ_DTRHO')
      CALL ALLOCATE_1D_DP(DETAU_DTRHO,NUMW,'DETAU_DTRHO')
      CALL ALLOCATE_1D_DP(DETAV_DTRHO,NUMW,'DETAV_DTRHO')
      CALL ALLOCATE_1D_DP(DRHOQ_DTRHO,NUMW,'DRHOQ_DTRHO')
      CALL ALLOCATE_1D_DP(DRHOU_DTRHO,NUMW,'DRHOU_DTRHO')
      CALL ALLOCATE_1D_DP(DRHOV_DTRHO,NUMW,'DRHOV_DTRHO')
      !
      ! Dpg at constant T
      !
      CALL ALLOCATE_1D_DP(DETAI_DPGT,NUMW,'DETAI_DPGT')
      CALL ALLOCATE_1D_DP(DETAQ_DPGT,NUMW,'DETAQ_DPGT')
      CALL ALLOCATE_1D_DP(DETAU_DPGT,NUMW,'DETAU_DPGT')
      CALL ALLOCATE_1D_DP(DETAV_DPGT,NUMW,'DETAV_DPGT')
      CALL ALLOCATE_1D_DP(DRHOQ_DPGT,NUMW,'DRHOQ_DPGT')
      CALL ALLOCATE_1D_DP(DRHOU_DPGT,NUMW,'DRHOU_DPGT')
      CALL ALLOCATE_1D_DP(DRHOV_DPGT,NUMW,'DRHOV_DPGT')
      !
      ! Drho at constant T
      !
      CALL ALLOCATE_1D_DP(DETAI_DRHOT,NUMW,'DETAI_DRHOT')
      CALL ALLOCATE_1D_DP(DETAQ_DRHOT,NUMW,'DETAQ_DRHOT')
      CALL ALLOCATE_1D_DP(DETAU_DRHOT,NUMW,'DETAU_DRHOT')
      CALL ALLOCATE_1D_DP(DETAV_DRHOT,NUMW,'DETAV_DRHOT')
      CALL ALLOCATE_1D_DP(DRHOQ_DRHOT,NUMW,'DRHOQ_DRHOT')
      CALL ALLOCATE_1D_DP(DRHOU_DRHOT,NUMW,'DRHOU_DRHOT')
      CALL ALLOCATE_1D_DP(DRHOV_DRHOT,NUMW,'DRHOV_DRHOT')
      !
      !
      !
      ! I terms:
      ! Dbx
      !
      CALL ALLOCATE_1D_DP(DIETAI_DBX,NUMW,'DIETAI_DBX')
      CALL ALLOCATE_1D_DP(DIETAQ_DBX,NUMW,'DIETAQ_DBX')
      CALL ALLOCATE_1D_DP(DIETAU_DBX,NUMW,'DIETAU_DBX')
      CALL ALLOCATE_1D_DP(DIETAV_DBX,NUMW,'DIETAV_DBX')
      CALL ALLOCATE_1D_DP(DIRHOQ_DBX,NUMW,'DIRHOQ_DBX')
      CALL ALLOCATE_1D_DP(DIRHOU_DBX,NUMW,'DIRHOU_DBX')
      CALL ALLOCATE_1D_DP(DIRHOV_DBX,NUMW,'DIRHOV_DBX')
      !
      ! Dby
      !
      CALL ALLOCATE_1D_DP(DIETAI_DBY,NUMW,'DIETAI_DBY')
      CALL ALLOCATE_1D_DP(DIETAQ_DBY,NUMW,'DIETAQ_DBY')
      CALL ALLOCATE_1D_DP(DIETAU_DBY,NUMW,'DIETAU_DBY')
      CALL ALLOCATE_1D_DP(DIETAV_DBY,NUMW,'DIETAV_DBY')
      CALL ALLOCATE_1D_DP(DIRHOQ_DBY,NUMW,'DIRHOQ_DBY')
      CALL ALLOCATE_1D_DP(DIRHOU_DBY,NUMW,'DIRHOU_DBY')
      CALL ALLOCATE_1D_DP(DIRHOV_DBY,NUMW,'DIRHOV_DBY')
      !
      ! Dbz
      !
      CALL ALLOCATE_1D_DP(DIETAI_DBZ,NUMW,'DIETAI_DBZ')
      CALL ALLOCATE_1D_DP(DIETAQ_DBZ,NUMW,'DIETAQ_DBZ')
      CALL ALLOCATE_1D_DP(DIETAU_DBZ,NUMW,'DIETAU_DBZ')
      CALL ALLOCATE_1D_DP(DIETAV_DBZ,NUMW,'DIETAV_DBZ')
      CALL ALLOCATE_1D_DP(DIRHOQ_DBZ,NUMW,'DIRHOQ_DBZ')
      CALL ALLOCATE_1D_DP(DIRHOU_DBZ,NUMW,'DIRHOU_DBZ')
      CALL ALLOCATE_1D_DP(DIRHOV_DBZ,NUMW,'DIRHOV_DBZ')
      !
      ! Dvlos
      !
      CALL ALLOCATE_1D_DP(DIETAI_DVLOS,NUMW,'DIETAI_DVLOS')
      CALL ALLOCATE_1D_DP(DIETAQ_DVLOS,NUMW,'DIETAQ_DVLOS')
      CALL ALLOCATE_1D_DP(DIETAU_DVLOS,NUMW,'DIETAU_DVLOS')
      CALL ALLOCATE_1D_DP(DIETAV_DVLOS,NUMW,'DIETAV_DVLOS')
      CALL ALLOCATE_1D_DP(DIRHOQ_DVLOS,NUMW,'DIRHOQ_DVLOS')
      CALL ALLOCATE_1D_DP(DIRHOU_DVLOS,NUMW,'DIRHOU_DVLOS')
      CALL ALLOCATE_1D_DP(DIRHOV_DVLOS,NUMW,'DIRHOV_DVLOS')
      !
      ! Dt at constant PG
      !
      CALL ALLOCATE_1D_DP(DIETAI_DTPG,NUMW,'DIETAI_DTPG')
      CALL ALLOCATE_1D_DP(DIETAQ_DTPG,NUMW,'DIETAQ_DTPG')
      CALL ALLOCATE_1D_DP(DIETAU_DTPG,NUMW,'DIETAU_DTPG')
      CALL ALLOCATE_1D_DP(DIETAV_DTPG,NUMW,'DIETAV_DTPG')
      CALL ALLOCATE_1D_DP(DIRHOQ_DTPG,NUMW,'DIRHOQ_DTPG')
      CALL ALLOCATE_1D_DP(DIRHOU_DTPG,NUMW,'DIRHOU_DTPG')
      CALL ALLOCATE_1D_DP(DIRHOV_DTPG,NUMW,'DIRHOV_DTPG')
      !
      ! Dt at constant RHO
      !
      CALL ALLOCATE_1D_DP(DIETAI_DTRHO,NUMW,'DIETAI_DTRHO')
      CALL ALLOCATE_1D_DP(DIETAQ_DTRHO,NUMW,'DIETAQ_DTRHO')
      CALL ALLOCATE_1D_DP(DIETAU_DTRHO,NUMW,'DIETAU_DTRHO')
      CALL ALLOCATE_1D_DP(DIETAV_DTRHO,NUMW,'DIETAV_DTRHO')
      CALL ALLOCATE_1D_DP(DIRHOQ_DTRHO,NUMW,'DIRHOQ_DTRHO')
      CALL ALLOCATE_1D_DP(DIRHOU_DTRHO,NUMW,'DIRHOU_DTRHO')
      CALL ALLOCATE_1D_DP(DIRHOV_DTRHO,NUMW,'DIRHOV_DTRHO')
      !
      ! Dpg at constant T
      !
      CALL ALLOCATE_1D_DP(DIETAI_DPGT,NUMW,'DIETAI_DPGT')
      CALL ALLOCATE_1D_DP(DIETAQ_DPGT,NUMW,'DIETAQ_DPGT')
      CALL ALLOCATE_1D_DP(DIETAU_DPGT,NUMW,'DIETAU_DPGT')
      CALL ALLOCATE_1D_DP(DIETAV_DPGT,NUMW,'DIETAV_DPGT')
      CALL ALLOCATE_1D_DP(DIRHOQ_DPGT,NUMW,'DIRHOQ_DPGT')
      CALL ALLOCATE_1D_DP(DIRHOU_DPGT,NUMW,'DIRHOU_DPGT')
      CALL ALLOCATE_1D_DP(DIRHOV_DPGT,NUMW,'DIRHOV_DPGT')
      !
      ! Drho at constant T
      !
      CALL ALLOCATE_1D_DP(DIETAI_DRHOT,NUMW,'DIETAI_DRHOT')
      CALL ALLOCATE_1D_DP(DIETAQ_DRHOT,NUMW,'DIETAQ_DRHOT')
      CALL ALLOCATE_1D_DP(DIETAU_DRHOT,NUMW,'DIETAU_DRHOT')
      CALL ALLOCATE_1D_DP(DIETAV_DRHOT,NUMW,'DIETAV_DRHOT')
      CALL ALLOCATE_1D_DP(DIRHOQ_DRHOT,NUMW,'DIRHOQ_DRHOT')
      CALL ALLOCATE_1D_DP(DIRHOU_DRHOT,NUMW,'DIRHOU_DRHOT')
      CALL ALLOCATE_1D_DP(DIRHOV_DRHOT,NUMW,'DIRHOV_DRHOT')
      !
    ENDIF
    !
  END SUBROUTINE ABS_MAT_INIT
  !
  !------------------------------------------------
  !
  SUBROUTINE GET_ABS_MAT (K,L,B,IDL,DAMP,WDIF)
    !
    INTEGER,   INTENT(IN)        :: K, L, B, IDL
    REAL(DP),  INTENT(IN)        :: DAMP, WDIF
    !
    !
    IF (MRESPFUNCT.EQV..TRUE.) THEN
      CALL GET_ABS_MAT_WDEV (K,L,B,IDL,DAMP,WDIF)
    ELSE
      CALL GET_ABS_MAT_WODEV (K,L,B,IDL,DAMP,WDIF)
    ENDIF
    !
  END SUBROUTINE GET_ABS_MAT
  !
  !------------------------------------------------
  !
  SUBROUTINE ABS_MAT_FIRST_STEP(L,B)
    !
    INTEGER, INTENT(IN)     :: L,B
    !
    ! matrix elements:
    IETAI(:)=ETAI(:)
    IETAQ(:)=ETAQ(:)
    IETAU(:)=ETAU(:)
    IETAV(:)=ETAV(:)
    IRHOQ(:)=RHOQ(:)
    IRHOU(:)=RHOU(:)
    IRHOV(:)=RHOV(:)
    ETAI(PIXEL_INI(L):PIXEL_END(L))=0.E0
    ETAQ(PIXEL_INI(L):PIXEL_END(L))=0.E0
    ETAU(PIXEL_INI(L):PIXEL_END(L))=0.E0
    ETAV(PIXEL_INI(L):PIXEL_END(L))=0.E0
    RHOQ(PIXEL_INI(L):PIXEL_END(L))=0.E0
    RHOU(PIXEL_INI(L):PIXEL_END(L))=0.E0
    RHOV(PIXEL_INI(L):PIXEL_END(L))=0.E0
    !
    IF (B.EQ.1) THEN
      IETAI(PIXEL_INI(L):PIXEL_END(L))=0.E0
      IETAQ(PIXEL_INI(L):PIXEL_END(L))=0.E0
      IETAU(PIXEL_INI(L):PIXEL_END(L))=0.E0
      IETAV(PIXEL_INI(L):PIXEL_END(L))=0.E0
      IRHOQ(PIXEL_INI(L):PIXEL_END(L))=0.E0
      IRHOU(PIXEL_INI(L):PIXEL_END(L))=0.E0
      IRHOV(PIXEL_INI(L):PIXEL_END(L))=0.E0
    ENDIF
    ! 
    IF (MRESPFUNCT.EQV..TRUE.) THEN
      ! 
! Derivatives:
!
! Dbx
      DIETAI_DBX(:)=DETAI_DBX(:)
      DIETAQ_DBX(:)=DETAQ_DBX(:)
      DIETAU_DBX(:)=DETAU_DBX(:)
      DIETAV_DBX(:)=DETAV_DBX(:)
      DIRHOQ_DBX(:)=DRHOQ_DBX(:)
      DIRHOU_DBX(:)=DRHOU_DBX(:)
      DIRHOV_DBX(:)=DRHOV_DBX(:)
      DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dby
      DIETAI_DBY(:)=DETAI_DBY(:)
      DIETAQ_DBY(:)=DETAQ_DBY(:)
      DIETAU_DBY(:)=DETAU_DBY(:)
      DIETAV_DBY(:)=DETAV_DBY(:)
      DIRHOQ_DBY(:)=DRHOQ_DBY(:)
      DIRHOU_DBY(:)=DRHOU_DBY(:)
      DIRHOV_DBY(:)=DRHOV_DBY(:)
      DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dbz
      DIETAI_DBZ(:)=DETAI_DBZ(:)
      DIETAQ_DBZ(:)=DETAQ_DBZ(:)
      DIETAU_DBZ(:)=DETAU_DBZ(:)
      DIETAV_DBZ(:)=DETAV_DBZ(:)
      DIRHOQ_DBZ(:)=DRHOQ_DBZ(:)
      DIRHOU_DBZ(:)=DRHOU_DBZ(:)
      DIRHOV_DBZ(:)=DRHOV_DBZ(:)
      DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dvlos
      DIETAI_DVLOS(:)=DETAI_DVLOS(:)
      DIETAQ_DVLOS(:)=DETAQ_DVLOS(:)
      DIETAU_DVLOS(:)=DETAU_DVLOS(:)
      DIETAV_DVLOS(:)=DETAV_DVLOS(:)
      DIRHOQ_DVLOS(:)=DRHOQ_DVLOS(:)
      DIRHOU_DVLOS(:)=DRHOU_DVLOS(:)
      DIRHOV_DVLOS(:)=DRHOV_DVLOS(:)
      DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dt_pg
      DIETAI_DTPG(:)=DETAI_DTPG(:)
      DIETAQ_DTPG(:)=DETAQ_DTPG(:)
      DIETAU_DTPG(:)=DETAU_DTPG(:)
      DIETAV_DTPG(:)=DETAV_DTPG(:)
      DIRHOQ_DTPG(:)=DRHOQ_DTPG(:)
      DIRHOU_DTPG(:)=DRHOU_DTPG(:)
      DIRHOV_DTPG(:)=DRHOV_DTPG(:)
      DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dt_rho
      DIETAI_DTRHO(:)=DETAI_DTRHO(:)
      DIETAQ_DTRHO(:)=DETAQ_DTRHO(:)
      DIETAU_DTRHO(:)=DETAU_DTRHO(:)
      DIETAV_DTRHO(:)=DETAV_DTRHO(:)
      DIRHOQ_DTRHO(:)=DRHOQ_DTRHO(:)
      DIRHOU_DTRHO(:)=DRHOU_DTRHO(:)
      DIRHOV_DTRHO(:)=DRHOV_DTRHO(:)
      DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dpg_t
      DIETAI_DPGT(:)=DETAI_DPGT(:)
      DIETAQ_DPGT(:)=DETAQ_DPGT(:)
      DIETAU_DPGT(:)=DETAU_DPGT(:)
      DIETAV_DPGT(:)=DETAV_DPGT(:)
      DIRHOQ_DPGT(:)=DRHOQ_DPGT(:)
      DIRHOU_DPGT(:)=DRHOU_DPGT(:)
      DIRHOV_DPGT(:)=DRHOV_DPGT(:)
      DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Drho_t
      DIETAI_DRHOT(:)=DETAI_DRHOT(:)
      DIETAQ_DRHOT(:)=DETAQ_DRHOT(:)
      DIETAU_DRHOT(:)=DETAU_DRHOT(:)
      DIETAV_DRHOT(:)=DETAV_DRHOT(:)
      DIRHOQ_DRHOT(:)=DRHOQ_DRHOT(:)
      DIRHOU_DRHOT(:)=DRHOU_DRHOT(:)
      DIRHOV_DRHOT(:)=DRHOV_DRHOT(:)
      DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      DRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      !
      IF (B.EQ.1) THEN
        DIETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dby
        DIETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dbz
        DIETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dvlos
        DIETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dt_pg
        DIETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dt_rho
        DIETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dpg_t
        DIETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))=0.E0
!
! Dpg_t
        DIETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
        DIRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L))=0.E0
      ENDIF
      !
    !
    ENDIF
    !
  END SUBROUTINE ABS_MAT_FIRST_STEP
  !
  !------------------------------------------------
  !
  SUBROUTINE ABS_MAT_END_STEP(L,B)
    !
    INTEGER, INTENT(IN)     :: L,B
    !
    IF (B.EQ.1) THEN
      ETAI(PIXEL_INI(L):PIXEL_END(L))=ETAI(PIXEL_INI(L):PIXEL_END(L)) &
          +IETAI(PIXEL_INI(L):PIXEL_END(L))
  !
      IF (MRESPFUNCT.EQV..TRUE.) THEN
  ! eta I derivatives:
  !
  ! Dbx
        DETAI_DBX(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DBX(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DBX(PIXEL_INI(L):PIXEL_END(L))
  ! Dby
        DETAI_DBY(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DBY(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DBY(PIXEL_INI(L):PIXEL_END(L))
  ! Dbz
        DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))
  ! Dvlos
        DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))
  ! Dt_pg
        DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))
  ! Dt_rho
        DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))
  ! Dpg_t
        DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))
  ! Drho_t
        DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L))
  !
      ENDIF
  !
    ELSE
      ETAI(PIXEL_INI(L):PIXEL_END(L))=(ETAI(PIXEL_INI(L):PIXEL_END(L)) &
          -KC(L))+IETAI(PIXEL_INI(L):PIXEL_END(L))
  !
      IF (MRESPFUNCT.EQV..TRUE.) THEN
  ! eta I derivatives:
  !
  ! Dbx
        DETAI_DBX(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DBX(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DBX(PIXEL_INI(L):PIXEL_END(L))
  ! Dby
        DETAI_DBY(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DBY(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DBY(PIXEL_INI(L):PIXEL_END(L))
  ! Dbz
        DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))
  ! Dvlos
        DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
            +DIETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))
  ! Dt_pg
        DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
            -DKCDTEMP_PG+DIETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))
  ! Dt_rho
        DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
            -DKCDTEMP_RHO+DIETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))
  ! Dpg_t
        DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
            -DKCDPG_TEMP+DIETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))
  ! Drho_t
        DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
            =DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
            -DKCDRHO_TEMP+DIETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L))
      ENDIF
  !
    ENDIF

    ETAQ(PIXEL_INI(L):PIXEL_END(L))=ETAQ(PIXEL_INI(L):PIXEL_END(L)) &
        +IETAQ(PIXEL_INI(L):PIXEL_END(L))
    ETAU(PIXEL_INI(L):PIXEL_END(L))=ETAU(PIXEL_INI(L):PIXEL_END(L)) &
        +IETAU(PIXEL_INI(L):PIXEL_END(L))
    ETAV(PIXEL_INI(L):PIXEL_END(L))=ETAV(PIXEL_INI(L):PIXEL_END(L)) &
        +IETAV(PIXEL_INI(L):PIXEL_END(L))
    RHOQ(PIXEL_INI(L):PIXEL_END(L))=RHOQ(PIXEL_INI(L):PIXEL_END(L)) &
        +IRHOQ(PIXEL_INI(L):PIXEL_END(L))
    RHOU(PIXEL_INI(L):PIXEL_END(L))=RHOU(PIXEL_INI(L):PIXEL_END(L)) &
        +IRHOU(PIXEL_INI(L):PIXEL_END(L))
    RHOV(PIXEL_INI(L):PIXEL_END(L))=RHOV(PIXEL_INI(L):PIXEL_END(L)) &
        +IRHOV(PIXEL_INI(L):PIXEL_END(L))
!
    IF (MRESPFUNCT.EQV..TRUE.) THEN
! eta Q derivatives:
! Dbx
      DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))
! Dby
      DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))
! Dbz
      DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))
! Dvlos
      DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))
! Dt_pg
      DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))
! Dt_rho
      DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))
! Dpg_t
      DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))
! Drho_t
      DETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))
!
! eta U derivatives:
! Dbx
      DETAU_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAU_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAU_DBX(PIXEL_INI(L):PIXEL_END(L))
! Dby
      DETAU_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAU_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAU_DBY(PIXEL_INI(L):PIXEL_END(L))
! Dbz
      DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))
! Dvlos
      DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))
! Dt_pg
      DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))
! Dt_rho
      DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))
! Dpg_t
      DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))
! Drho_t
      DETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L))
!
! eta V derivatives:
! Dbx
      DETAV_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAV_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAV_DBX(PIXEL_INI(L):PIXEL_END(L))
! Dby
      DETAV_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAV_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAV_DBY(PIXEL_INI(L):PIXEL_END(L))
! Dbz
      DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))
! Dvlos
      DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))
! Dt_pg
      DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))
! Dt_rho
      DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))
! Dpg_t
      DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))
! Drho_t
      DETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          =DETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L))
!
!
! rho Q derivatives:
! Dbx
      DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))
! Dby
      DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))
! Dbz
      DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))
! Dvlos
      DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))
! Dt_pg
      DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))
! Dt_rho
      DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))
! Dpg_t
      DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))
! Drho_t
      DRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))
!
! rho U derivatives:
! Dbx
      DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))
! Dby
      DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))
! Dbz
      DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))
! Dvlos
      DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))
! Dt_pg
      DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))
! Dt_rho
      DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))
! Dpg_t
      DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))
! Drho_t
      DRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L))
!
! rho V derivatives:
! Dbx
      DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))
! Dby
      DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))
! Dbz
      DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))
! Dvlos
      DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))
! Dt_pg
      DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))
! Dt_rho
      DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))
! Dpg_t
      DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))
! Drho_t
      DRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          =DRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L)) &
          +DIRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L))
    !
    ENDIF
    !
  END SUBROUTINE ABS_MAT_END_STEP
  !
  !------------------------------------------------
  !
  SUBROUTINE GET_ABS_MAT_WODEV (K,L,B,IDL,DAMP,WDIF)
    !
    USE ATOM_DATABASE, ONLY: MATOM
    !
    IMPLICIT NONE
    !
    INTEGER,   INTENT(IN)        :: K, L, B, IDL
    REAL(DP),  INTENT(IN)        :: DAMP, WDIF
    !
    INTEGER                      :: M, N, COUNT
    REAL(DP)                     :: VDOPPLER, DLDOPPLER
    REAL(DP)                     :: DELTAL_V, DELTAL_B
    REAL(DP)                     :: BFIELD, BFIELD2
    REAL(DP)                     :: BBX, BBY, BBZ, BBX2, BBY2, BBZ2
    REAL(DP)                     :: BX2MBY2, BX2PBY2
    REAL(DP)                     :: COSGAMMA, COSGAMMAFAC, SINGAMMAFAC, COS2PHI, SIN2PHI
    REAL(DP)                     :: SINGAMMA, SIN2GAMMA
    REAL(DP), ALLOCATABLE        :: HH(:), FF(:), UU(:)
    REAL(DP), ALLOCATABLE        :: SHH(:), SFF(:)
    LOGICAL                      :: NAN, CHECKNAN
    !
    CALL ABS_MAT_FIRST_STEP(L,B)
    !
!    ETAI(PIXEL_INI(L):PIXEL_END(L))=0.D0
!    ETAQ(PIXEL_INI(L):PIXEL_END(L))=0.D0
!    ETAU(PIXEL_INI(L):PIXEL_END(L))=0.D0
!    ETAV(PIXEL_INI(L):PIXEL_END(L))=0.D0
!    RHOQ(PIXEL_INI(L):PIXEL_END(L))=0.D0
!    RHOU(PIXEL_INI(L):PIXEL_END(L))=0.D0
!    RHOV(PIXEL_INI(L):PIXEL_END(L))=0.D0
    !
    !
    ! Allocate arrays for Voigt and Faraday functions
    !
    CALL ALLOCATE_1D_DP(HH,NUMWAVE(L),'HH ALLOCATION')
    CALL ALLOCATE_1D_DP(FF,NUMWAVE(L),'FF ALLOCATION')
    CALL ALLOCATE_1D_DP(UU,NUMWAVE(L),'UU ALLOCATION')
    CALL ALLOCATE_1D_DP(SHH,NUMWAVE(L),'SHH ALLOCATION')
    CALL ALLOCATE_1D_DP(SFF,NUMWAVE(L),'SFF ALLOCATION')
    !
!.    ! Allocate various variables for derivatives:
!.    CALL ALLOCATE_1D_DP(DUUDT, NUMWAVE(L), 'DUUDT ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DETAI_DU, NUMWAVE(L), 'DETAI_DU ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DETAQ_DU, NUMWAVE(L), 'DETAQ_DU ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DETAU_DU, NUMWAVE(L), 'DETAU_DU ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DETAV_DU, NUMWAVE(L), 'DETAV_DU ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DRHOQ_DU, NUMWAVE(L), 'DRHOQ_DU ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DRHOU_DU, NUMWAVE(L), 'DRHOU_DU ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DRHOV_DU, NUMWAVE(L), 'DRHOV_DU ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DETAI_DA, NUMWAVE(L), 'DETAI_DA ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DETAQ_DA, NUMWAVE(L), 'DETAQ_DA ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DETAU_DA, NUMWAVE(L), 'DETAU_DA ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DETAV_DA, NUMWAVE(L), 'DETAV_DA ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DRHOQ_DA, NUMWAVE(L), 'DRHOQ_DA ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DRHOU_DA, NUMWAVE(L), 'DRHOU_DA ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DRHOV_DA, NUMWAVE(L), 'DRHOV_DA ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DH_DVDOPP, NUMWAVE(L), 'DH_DVOPP ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DL_DDAMP, NUMWAVE(L), 'DL_DDMP ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DH_DDAMP, NUMWAVE(L), 'DH_DDMP ALLOCATION')
!.    CALL ALLOCATE_1D_DP(DL_DVDOPP, NUMWAVE(L), 'DL_DVOPP ALLOCATION')
!.    !
    ! Doppler width of the spectral line
    ! Note:  VDOPPLER here is different from that of the module collisional_damping
    ! Here, the factor PI^(-1/2) does not appear. It is only a matter of definition
    !
    VDOPPLER=DSQRT(2.D0*KBOL*TEM(K)/(MATOM(LINE_ZN(IDL))*MAMU)) ! cm/s
    DLDOPPLER=1D3*(VDOPPLER*LINE_L0(IDL)/LIGHT)                 ! mA
    !
    ! Cartesian coordinates of the magnetic field
    !
    BBX=DBLE(BX(K))
    BBY=DBLE(BY(K))
    BBZ=DBLE(BZ(K))
    BBX2=BBX**2.D0
    BBY2=BBY**2.D0
    BBZ2=BBZ**2.D0
    BX2MBY2=BBX2-BBY2
    BX2PBY2=BBX2+BBY2
    !
    ! Magnetic field strength
    !
    BFIELD2=BBX**2.D0+BBY**2.D0+BBZ**2.D0
    BFIELD=DSQRT(BFIELD2)
    !
    ! Factors in terms of the spherical coordinates of the magnetic field
    !
    COSGAMMA=0.D0
    COSGAMMAFAC=1.D0
    SINGAMMAFAC=1.D0
    COS2PHI=0.D0
    SIN2PHI=0.D0
    SINGAMMA=0.D0
    SIN2GAMMA=0.D0
!.    ! Some magnetic field derivatives
!.    DCOSGAMMAFAC_DBX=0.D0
!.    DCOSGAMMAFAC_DBY=0.D0
!.    DCOSGAMMAFAC_DBZ=0.D0
!.    DSINGAMMAFAC_DBX=0.D0
!.    DSINGAMMAFAC_DBY=0.D0
!.    DSINGAMMAFAC_DBZ=0.D0
!.    DCOS2PHI_DBX=0.D0
!.    DCOS2PHI_DBY=0.D0
!.    DCOS2PHI_DBZ=0.D0
!.    DSIN2PHI_DBX=0.D0
!.    DSIN2PHI_DBY=0.D0
!.    DSIN2PHI_DBZ=0.D0
!.    DCOSGAMMA_DBX=0.D0
!.    DCOSGAMMA_DBY=0.D0
!.    DCOSGAMMA_DBZ=0.D0
!.    DB_DBX=0.D0
!.    DB_DBY=0.D0
!.    DB_DBZ=0.D0
!.    !
    IF (BFIELD.GT.0) THEN
       COSGAMMA=BBZ/BFIELD                              ! COS(GAMMA)
       COSGAMMAFAC=1+BBZ2/BFIELD2                       ! 1+COS(GAMMA)^2
       SINGAMMAFAC=1-BBZ2/BFIELD2                       ! SIN(GAMMA)^2
       SINGAMMA=SQRT(BBX2+BBY2)/BFIELD                  ! SIN(GAMMA)
       SIN2GAMMA=2.0*COSGAMMA*SINGAMMA                  ! SIN(2GAMMA)
!.       ! Some magnetic field derivatives
!.       DCOSGAMMAFAC_DBX=-2.E0*BBX*BBZ2/BFIELD2/BFIELD2
!.       DCOSGAMMAFAC_DBY=-2.E0*BBY*BBZ2/BFIELD2/BFIELD2
!.       DCOSGAMMAFAC_DBZ=(2.E0*BBZ*(BFIELD2-BBZ2))/BFIELD2/BFIELD2
!.       DSINGAMMAFAC_DBX=-DCOSGAMMAFAC_DBX
!.       DSINGAMMAFAC_DBY=-DCOSGAMMAFAC_DBY
!.       DSINGAMMAFAC_DBZ=-DCOSGAMMAFAC_DBZ
!.       DCOS2PHI_DBX=4.E0*BBX*BBY2/BX2PBY2/BX2PBY2
!.       DCOS2PHI_DBY=-4.E0*BBY*BBX2/BX2PBY2/BX2PBY2
!.       DCOS2PHI_DBZ=0.E0
!.       DSIN2PHI_DBX=-2.E0*BBY*BX2MBY2/BX2PBY2/BX2PBY2
!.       DSIN2PHI_DBY=2.E0*BBX*BX2MBY2/BX2PBY2/BX2PBY2
!.       DSIN2PHI_DBZ=0.E0
!.       DCOSGAMMA_DBX=-BBZ*BBX/BFIELD/BFIELD2
!.       DCOSGAMMA_DBY=-BBZ*BBY/BFIELD/BFIELD2
!.       DCOSGAMMA_DBZ=(1.E0-COSGAMMA*COSGAMMA)/BFIELD
!.       DB_DBX=BBX/BFIELD
!.       DB_DBY=BBY/BFIELD
!.       DB_DBZ=BBZ/BFIELD
    ENDIF
    IF (BBX.NE.0.OR.BBY.NE.0) THEN
       COS2PHI=BX2MBY2/BX2PBY2                          ! COS(2PHI)
       SIN2PHI=2.*BBX*BBY/BX2PBY2                       ! SIN(2PHI)
    ENDIF
    !
    !
    ! Checking for NaN
    !
    NAN=.FALSE.
    NAN=CHECKNAN(COSGAMMA)
    NAN=CHECKNAN(COSGAMMAFAC)
    NAN=CHECKNAN(SINGAMMAFAC)
    NAN=CHECKNAN(COS2PHI)
    NAN=CHECKNAN(SIN2PHI)
    IF (NAN.EQV..TRUE.) THEN
       PRINT*,'NaN detected in gamma,phi factors'
       PRINT*,COSGAMMA,COSGAMMAFAC,SINGAMMAFAC,COS2PHI,SIN2PHI
       PRINT*, 'B: ', DBLE(BX(K)), DBLE(BY(K)), DBLE(BZ(K)) &
           , ' ; BB: ', BBX, BBY, BBZ, ' ; BB2: ', BBX2, BBY2, BBZ2 &
           , ' ; BXY: ', BX2MBY2, BX2PBY2, ' ; B: ', BFIELD2, BFIELD
       STOP
    ENDIF
    !
    ! Initialize Zeeman pattern for spectral line L
    !
    CALL ZEEMAN_COMP(IDL)
    !
    ! DELTA_V is independent of the magnetic sublevel considered:
    DELTAL_V=-1D3*LINE_L0(IDL)*DBLE(VZ(K))/LIGHT
        ! mA (if Vz in cm/s); Vz < 0 is a blueshift
    !
    ! Derivative of UU with respect to VLOS. It is not M dependent:
!.    DUUDVLOS=(-1D3*LINE_L0(IDL)/LIGHT)/DLDOPPLER
    !
    ! Start loop over components of the Zeeman pattern
    !
    DO M=1,NTOT
       COUNT=1
       UU(:)=0D0
       DO N=PIXEL_INI(L),PIXEL_END(L)
          DELTAL_B=LAMBDA_SC(M)*BFIELD                       ! mA
          UU(COUNT)=DBLE((WAVE(N)-WDIF+DELTAL_B+DELTAL_V)/DLDOPPLER)
!          IF (ABS(UU(COUNT)).GT.1E4) THEN
!             PRINT*, 'UU TOO LARGE'
!             PRINT*,UU(COUNT),WAVE(N)-WDIF,DELTAL_B,DELTAL_V,DLDOPPLER
!             PRINT*,LINE_L0(IDL),VZ(K)
!             STOP
!          ENDIF
          NAN=.FALSE.
          NAN=CHECKNAN(DBLE(UU(COUNT)))
          IF (NAN.EQV..TRUE.) THEN
             PRINT*,'NaN detected in UU'
             PRINT*,UU(COUNT),WAVE(N)-WDIF,DELTAL_B,DELTAL_V,DLDOPPLER, VZ(K)
PRINT*, BX(K), BY(K), BZ(K), TEM(K), VZ(K)
             PRINT*,'NaN detected in UU End'
             STOP
          ENDIF
          COUNT=COUNT+1
       ENDDO
       NAN=.FALSE.
       NAN=CHECKNAN(DBLE(STRENGTH_SC(M)))
       IF (NAN.EQV..TRUE.) THEN
          PRINT*,'NaN detected in STRENGTH_SC'
          PRINT*,STRENGTH_SC(M),TYPE_SC(M),LAMBDA_SC(M)
          STOP
       ENDIF
       !
       ! Determine Voigt and Faraday functions
       !
       CALL VOIGT(NUMWAVE(L),DBLE(DAMP),UU,HH,FF)
       !
!.       ! Voight and Faraday derivatives times the Zeeman component strength:
!.       DH_DVDOPP=2.D0*(-UU*HH+DAMP*FF)*STRENGTH_SC(M)
!.       DL_DDAMP=DH_DVDOPP
!.       DH_DDAMP=2.D0*(-1.D0/DSQRT(DPI)+DAMP*HH+UU*FF)*STRENGTH_SC(M)
!.       DL_DVDOPP=-DH_DDAMP
!.       !
!.       DUUDB=LAMBDA_SC(M)/DLDOPPLER
!.       !
!.       DUUDT(:)=-0.5D0/DBLE(TEM(K))*UU(:)
       !
       !
       ! Add contribution to the different elements of the absorption matrix
       !
       SHH(:)=STRENGTH_SC(M)*HH(:)
       SFF(:)=STRENGTH_SC(M)*FF(:)
       !
       SELECT CASE(TYPE_SC(M))
       CASE(-1) ! SIGMA_RED
          ETAI(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAI(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*COSGAMMAFAC)
          ETAQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAQ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*SINGAMMAFAC*COS2PHI)
          ETAU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAU(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*SINGAMMAFAC*SIN2PHI)
          ETAV(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAV(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*COSGAMMA)
          RHOQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOQ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*SINGAMMAFAC*COS2PHI)
          RHOU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOU(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*SINGAMMAFAC*SIN2PHI)
          RHOV(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOV(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*COSGAMMA)
!.          !
!.          ! Derivatives:
!.          !
!.          ! Du
!.          !
!.          DETAI_DU(:)=0.25*DH_DVDOPP(:)*COSGAMMAFAC
!.          DETAQ_DU(:)=-0.25*DH_DVDOPP(:)*SINGAMMAFAC*COS2PHI
!.          DETAU_DU(:)=-0.25*DH_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
!.          DETAV_DU(:)=0.5*DH_DVDOPP(:)*COSGAMMA
!.          DRHOQ_DU(:)=-0.25*DL_DVDOPP(:)*SINGAMMAFAC*COS2PHI
!.          DRHOU_DU(:)=-0.25*DL_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
!.          DRHOV_DU(:)=0.5*DL_DVDOPP(:)*COSGAMMA
!.          !
!.          ! Da
!.          !
!.          DETAI_DA(:)=0.25*DH_DDAMP(:)*COSGAMMAFAC
!.          DETAQ_DA(:)=-0.25*DH_DDAMP(:)*SINGAMMAFAC*COS2PHI
!.          DETAU_DA(:)=-0.25*DH_DDAMP(:)*SINGAMMAFAC*SIN2PHI
!.          DETAV_DA(:)=0.50*DH_DDAMP(:)*COSGAMMA
!.          DRHOQ_DA(:)=-0.25*DL_DDAMP(:)*SINGAMMAFAC*COS2PHI
!.          DRHOU_DA(:)=-0.25*DL_DDAMP(:)*SINGAMMAFAC*SIN2PHI
!.          DRHOV_DA(:)=0.50*DL_DDAMP(:)*COSGAMMA
!.          !
!.          ! Dbx
!.          !
!.          DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.25*SHH(:)*DCOSGAMMAFAC_DBX)
!.          DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
!.          DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
!.          DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*DCOSGAMMA_DBX)
!.          DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
!.          DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
!.          DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*DCOSGAMMA_DBX)
!.          !
!.          ! Dby
!.          !
!.          DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.25*SHH(:)*DCOSGAMMAFAC_DBY)
!.          DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
!.          DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
!.          DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*DCOSGAMMA_DBY)
!.          DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
!.          DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
!.          DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*DCOSGAMMA_DBY)
!.          !
!.          ! Dbz
!.          !
!.          DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.25*SHH(:)*DCOSGAMMAFAC_DBZ)
!.          DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
!.          DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
!.          DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*DCOSGAMMA_DBZ)
!.          DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
!.          DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
!.          DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*DCOSGAMMA_DBZ)
!.          !
       CASE(0) ! PI
          ETAI(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAI(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*SINGAMMAFAC)
          ETAQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAQ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*SINGAMMAFAC*COS2PHI)
          ETAU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAU(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*SINGAMMAFAC*SIN2PHI)
          RHOQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOQ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*SINGAMMAFAC*COS2PHI)
          RHOU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOU(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*SINGAMMAFAC*SIN2PHI)
!.          !
!.          ! Derivatives:
!.          !
!.          ! Du
!.          !
!.          DETAI_DU(:)=0.5*DH_DVDOPP(:)*SINGAMMAFAC
!.          DETAQ_DU(:)=0.5*DH_DVDOPP(:)*SINGAMMAFAC*COS2PHI
!.          DETAU_DU(:)=0.5*DH_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
!.          DRHOQ_DU(:)=0.5*DL_DVDOPP(:)*SINGAMMAFAC*COS2PHI
!.          DRHOU_DU(:)=0.5*DL_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
!.          !
!.          ! Da
!.          !
!.          DETAI_DA(:)=0.5*DH_DDAMP(:)*SINGAMMAFAC
!.          DETAQ_DA(:)=0.5*DH_DDAMP(:)*SINGAMMAFAC*COS2PHI
!.          DETAU_DA(:)=0.5*DH_DDAMP(:)*SINGAMMAFAC*SIN2PHI
!.          DRHOQ_DA(:)=0.5*DL_DDAMP(:)*SINGAMMAFAC*COS2PHI
!.          DRHOU_DA(:)=0.5*DL_DDAMP(:)*SINGAMMAFAC*SIN2PHI
!.          !
!.          ! Dbx
!.          !
!.          DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*DSINGAMMAFAC_DBX)
!.          DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
!.          DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
!.          DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
!.          DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
!.          !
!.          ! Dby
!.          !
!.          DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*DSINGAMMAFAC_DBY)
!.          DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
!.          DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
!.          DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
!.          DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
!.          !
!.          ! Dbz
!.          !
!.          DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*DSINGAMMAFAC_DBZ)
!.          DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
!.          DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SHH(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
!.          DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
!.          DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.              REAL(DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.5*SFF(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
!.          !
       CASE(1) ! SIGMA_BLUE
          ETAI(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAI(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*COSGAMMAFAC)
          ETAQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAQ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*SINGAMMAFAC*COS2PHI)
          ETAU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAU(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*SINGAMMAFAC*SIN2PHI)
          ETAV(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAV(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SHH(:)*COSGAMMA)
          RHOQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOQ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*SINGAMMAFAC*COS2PHI)
          RHOU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOU(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*SINGAMMAFAC*SIN2PHI)
          RHOV(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOV(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SFF(:)*COSGAMMA)
!.          !
!.          ! Derivatives:
!.          !
!.          ! Du
!.          !
!.          DETAI_DU(:)=0.25*DH_DVDOPP(:)*COSGAMMAFAC
!.          DETAQ_DU(:)=-0.25*DH_DVDOPP(:)*SINGAMMAFAC*COS2PHI
!.          DETAU_DU(:)=-0.25*DH_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
!.          DETAV_DU(:)=-0.5*DH_DVDOPP(:)*COSGAMMA
!.          DRHOQ_DU(:)=-0.25*DL_DVDOPP(:)*SINGAMMAFAC*COS2PHI
!.          DRHOU_DU(:)=-0.25*DL_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
!.          DRHOV_DU(:)=-0.5*DL_DVDOPP(:)*COSGAMMA
!.          !
!.          ! Da
!.          !
!.          DETAI_DA(:)=0.25*DH_DDAMP(:)*COSGAMMAFAC
!.          DETAQ_DA(:)=-0.25*DH_DDAMP(:)*SINGAMMAFAC*COS2PHI
!.          DETAU_DA(:)=-0.25*DH_DDAMP(:)*SINGAMMAFAC*SIN2PHI
!.          DETAV_DA(:)=-0.50*DH_DDAMP(:)*COSGAMMA
!.          DRHOQ_DA(:)=-0.25*DL_DDAMP(:)*SINGAMMAFAC*COS2PHI
!.          DRHOU_DA(:)=-0.25*DL_DDAMP(:)*SINGAMMAFAC*SIN2PHI
!.          DRHOV_DA(:)=-0.50*DL_DDAMP(:)*COSGAMMA
!.          !
!.          ! Dbx
!.          !
!.          DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.25*SHH(:)*DCOSGAMMAFAC_DBX)
!.          DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
!.          DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
!.          DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.5*SHH(:)*DCOSGAMMA_DBX)
!.          DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
!.          DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
!.          DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.5*SFF(:)*DCOSGAMMA_DBX)
!.          !
!.          ! Dby
!.          !
!.          DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.25*SHH(:)*DCOSGAMMAFAC_DBY)
!.          DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
!.          DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
!.          DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.5*SHH(:)*DCOSGAMMA_DBY)
!.          DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
!.          DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
!.          DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.5*SFF(:)*DCOSGAMMA_DBY)
!.          !
!.          ! Dbz
!.          !
!.          DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             +0.25*SHH(:)*DCOSGAMMAFAC_DBZ)
!.          DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
!.          DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SHH(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
!.          DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.5*SHH(:)*DCOSGAMMA_DBZ)
!.          DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
!.          DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.25*SFF(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
!.          DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.             REAL(DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))&
!.             -0.5*SFF(:)*DCOSGAMMA_DBZ)
!.          !
       END SELECT
!.       !
!.       ! Dt at constant PG
!.       !
!.       DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAI_DU(:)*DUUDT+DETAI_DA(:)*DDAMDTEMP_PG)
!.       DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAQ_DU(:)*DUUDT+DETAQ_DA(:)*DDAMDTEMP_PG)
!.       DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAU_DU(:)*DUUDT+DETAU_DA(:)*DDAMDTEMP_PG)
!.       DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAV_DU(:)*DUUDT+DETAV_DA(:)*DDAMDTEMP_PG)
!.       DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOQ_DU(:)*DUUDT+DRHOQ_DA(:)*DDAMDTEMP_PG)
!.       DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOU_DU(:)*DUUDT+DRHOU_DA(:)*DDAMDTEMP_PG)
!.       DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOV_DU(:)*DUUDT+DRHOV_DA(:)*DDAMDTEMP_PG)
!.       !
!.       ! Dt at constant RHO
!.       !
!.       DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAI_DU(:)*DUUDT+DETAI_DA(:)*DDAMDTEMP_RHO)
!.       DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAQ_DU(:)*DUUDT+DETAQ_DA(:)*DDAMDTEMP_RHO)
!.       DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAU_DU(:)*DUUDT+DETAU_DA(:)*DDAMDTEMP_RHO)
!.       DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAV_DU(:)*DUUDT+DETAV_DA(:)*DDAMDTEMP_RHO)
!.       DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOQ_DU(:)*DUUDT+DRHOQ_DA(:)*DDAMDTEMP_RHO)
!.       DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOU_DU(:)*DUUDT+DRHOU_DA(:)*DDAMDTEMP_RHO)
!.       DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOV_DU(:)*DUUDT+DRHOV_DA(:)*DDAMDTEMP_RHO)
!.       !
!.       ! Dbx
!.       !
!.       DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))+DETAI_DU(:)*DUUDB*DB_DBX)
!.       DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))+DETAQ_DU(:)*DUUDB*DB_DBX)
!.       DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))+DETAU_DU(:)*DUUDB*DB_DBX)
!.       DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))+DETAV_DU(:)*DUUDB*DB_DBX)
!.       DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))+DRHOQ_DU(:)*DUUDB*DB_DBX)
!.       DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))+DRHOU_DU(:)*DUUDB*DB_DBX)
!.       DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))+DRHOV_DU(:)*DUUDB*DB_DBX)
!.       !
!.       ! Dby
!.       !
!.       DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))+DETAI_DU(:)*DUUDB*DB_DBY)
!.       DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))+DETAQ_DU(:)*DUUDB*DB_DBY)
!.       DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))+DETAU_DU(:)*DUUDB*DB_DBY)
!.       DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))+DETAV_DU(:)*DUUDB*DB_DBY)
!.       DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))+DRHOQ_DU(:)*DUUDB*DB_DBY)
!.       DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))+DRHOU_DU(:)*DUUDB*DB_DBY)
!.       DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))+DRHOV_DU(:)*DUUDB*DB_DBY)
!.       !
!.       ! Dbz
!.       !
!.       DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))+DETAI_DU(:)*DUUDB*DB_DBZ)
!.       DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))+DETAQ_DU(:)*DUUDB*DB_DBZ)
!.       DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))+DETAU_DU(:)*DUUDB*DB_DBZ)
!.       DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))+DETAV_DU(:)*DUUDB*DB_DBZ)
!.       DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))+DRHOQ_DU(:)*DUUDB*DB_DBZ)
!.       DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))+DRHOU_DU(:)*DUUDB*DB_DBZ)
!.       DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))+DRHOV_DU(:)*DUUDB*DB_DBZ)
!.       !
!.       ! Dvlos
!.       !
!.       DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DETAI_DU(:)*DUUDVLOS)
!.       DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DETAQ_DU(:)*DUUDVLOS)
!.       DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DETAU_DU(:)*DUUDVLOS)
!.       DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DETAV_DU(:)*DUUDVLOS)
!.       DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DRHOQ_DU(:)*DUUDVLOS)
!.       DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DRHOU_DU(:)*DUUDVLOS)
!.       DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DRHOV_DU(:)*DUUDVLOS)
!.       !
!.       ! Dpg
!.       !
!.       DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAI_DA(:))
!.       DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAQ_DA(:))
!.       DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAU_DA(:))
!.       DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))&
!.           +DETAV_DA(:))
!.       DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOQ_DA(:))
!.       DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOU_DA(:))
!.       DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
!.           REAL(DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))&
!.           +DRHOV_DA(:))
!.       !
       HH(:)=0D0
       FF(:)=0D0
       SHH(:)=0D0
       SFF(:)=0D0
!.       !
!.       DETAI_DU(:)=0.D0
!.       DETAV_DU(:)=0.D0
!.       DETAQ_DU(:)=0.D0
!.       DETAU_DU(:)=0.D0
!.       DRHOV_DU(:)=0.D0
!.       DRHOQ_DU(:)=0.D0
!.       DRHOU_DU(:)=0.D0
!.       !
!.       DETAI_DA(:)=0.D0
!.       DETAV_DA(:)=0.D0
!.       DETAQ_DA(:)=0.D0
!.       DETAU_DA(:)=0.D0
!.       DRHOV_DA(:)=0.D0
!.       DRHOQ_DA(:)=0.D0
!.       DRHOU_DA(:)=0.D0
!.       !
    ENDDO
!.    !
!.    ! Dt at constant PG
!.    ! WARNING! It is important to have these lines before the various ETAs and RHOs statements!
!.    !
!.    DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKCDTEMP_PG&
!.        +DKLDTEMP_PG*ETAI(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))
!.    DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_PG*ETAQ(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))
!.    DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_PG*ETAU(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))
!.    DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_PG*ETAV(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_PG*RHOQ(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_PG*RHOU(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_PG*RHOV(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))
!.    !
!.    ! Dt at constant RHO
!.    ! WARNING! It is important to have these lines before the various ETAs and RHOs statements!
!.    !
!.    DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKCDTEMP_RHO&
!.        +DKLDTEMP_RHO*ETAI(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))
!.    DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_RHO*ETAQ(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))
!.    DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_RHO*ETAU(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))
!.    DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_RHO*ETAV(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_RHO*RHOQ(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_RHO*RHOU(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
!.        DKLDTEMP_RHO*RHOV(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))
!.    !
!.    ! Dpg
!.    !
!.    DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
!.        DKCDPG_TEMP&
!.        +DKLDPG_TEMP*ETAI(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))&
!.        *DDAMDPG_TEMP)
!.    DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
!.        DKLDPG_TEMP*ETAQ(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
!.    DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
!.        DKLDPG_TEMP*ETAU(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
!.    DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
!.        DKLDPG_TEMP*ETAV(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
!.    DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
!.        DKLDPG_TEMP*RHOQ(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
!.    DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
!.        DKLDPG_TEMP*RHOU(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
!.    DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
!.        DKLDPG_TEMP*RHOV(PIXEL_INI(L):PIXEL_END(L))&
!.        +KLIN(L)*DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
    !
    !
    ! Add line and continuum contribution
    !
    ETAI(PIXEL_INI(L):PIXEL_END(L))=KC(L)+KLIN(L,B)&
        *ETAI(PIXEL_INI(L):PIXEL_END(L))
    ETAV(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *ETAV(PIXEL_INI(L):PIXEL_END(L))
    ETAQ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *ETAQ(PIXEL_INI(L):PIXEL_END(L))
    ETAU(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *ETAU(PIXEL_INI(L):PIXEL_END(L))
    RHOV(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *RHOV(PIXEL_INI(L):PIXEL_END(L))
    RHOQ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *RHOQ(PIXEL_INI(L):PIXEL_END(L))
    RHOU(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *RHOU(PIXEL_INI(L):PIXEL_END(L))
!.    !
!.    ! Derivatives:
!.    !
!.    ! Dbx
!.    !
!.    DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))
!.    DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))
!.    DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))
!.    DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))
!.    !
!.    ! Dby
!.    !
!.    DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))
!.    DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))
!.    DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))
!.    DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))
!.    !
!.    ! Dbz
!.    !
!.    DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))
!.    DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))
!.    DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))
!.    DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))
!.    !
!.    ! Dvlos
!.    !
!.    DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))
!.    DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))
!.    DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))
!.    DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))
!.    DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L)*DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))
!.    !
    DEALLOCATE(HH, FF, UU)
    DEALLOCATE(SHH, SFF)
    DEALLOCATE(TYPE_SC, LAMBDA_SC, STRENGTH_SC)
    !
    CALL ABS_MAT_END_STEP(L,B)
    !
!.    DEALLOCATE(DUUDT)
!.    DEALLOCATE(DETAI_DU, DETAV_DU, DETAQ_DU, DETAU_DU, DRHOV_DU, DRHOQ_DU, DRHOU_DU)
!.    DEALLOCATE(DETAI_DA, DETAQ_DA, DETAU_DA, DETAV_DA, DRHOQ_DA, DRHOU_DA, DRHOV_DA)
!.    DEALLOCATE(DH_DVDOPP, DL_DDAMP, DH_DDAMP, DL_DVDOPP)
!.    !
  END SUBROUTINE GET_ABS_MAT_WODEV
  !
  !------------------------------------------------
  !
  SUBROUTINE GET_ABS_MAT_WDEV (K,L,B,IDL,DAMP,WDIF)!,ETAI,ETAQ,ETAU,ETAV,RHOQ,RHOU,RHOV)
    !
    USE ATOM_DATABASE, ONLY: MATOM
    !
    IMPLICIT NONE
    !
    INTEGER,   INTENT(IN)        :: K, L, B, IDL
    REAL(DP),  INTENT(IN)        :: DAMP, WDIF
    !REAL(DP),  INTENT(INOUT)     :: ETAI(NUMW),ETAQ(NUMW),ETAU(NUMW),ETAV(NUMW),RHOQ(NUMW),RHOU(NUMW),RHOV(NUMW)
    !
    INTEGER                      :: M, N, COUNT
    REAL(DP)                     :: VDOPPLER, DLDOPPLER
    REAL(DP)                     :: DELTAL_V, DELTAL_B
    REAL(DP)                     :: BFIELD, BFIELD2
    REAL(DP)                     :: BBX, BBY, BBZ, BBX2, BBY2, BBZ2
    REAL(DP)                     :: BX2MBY2, BX2PBY2
    REAL(DP)                     :: DB_DBX, DB_DBY, DB_DBZ
    REAL(DP)                     :: DUUDVLOS
    REAL(DP)                     :: COSGAMMA, COSGAMMAFAC, SINGAMMAFAC, COS2PHI, SIN2PHI
    REAL(DP)                     :: SINGAMMA, SIN2GAMMA
    REAL(DP), ALLOCATABLE        :: HH(:), FF(:), UU(:), DUUDT(:)
    REAL(DP), ALLOCATABLE        :: SHH(:), SFF(:)
    REAL(DP), ALLOCATABLE        :: DH_DVDOPP(:), DL_DDAMP(:), DH_DDAMP(:), DL_DVDOPP(:)
    REAL(DP), ALLOCATABLE        :: DETAI_DU(:), DETAQ_DU(:), DETAU_DU(:), DETAV_DU(:)
    REAL(DP), ALLOCATABLE        :: DRHOQ_DU(:), DRHOU_DU(:), DRHOV_DU(:)
    REAL(DP), ALLOCATABLE        :: DETAI_DA(:), DETAQ_DA(:), DETAU_DA(:), DETAV_DA(:)
    REAL(DP), ALLOCATABLE        :: DRHOQ_DA(:), DRHOU_DA(:), DRHOV_DA(:)
    REAL(DP)                     :: DUUDB
    LOGICAL                      :: NAN, CHECKNAN
    REAL(DP)                     :: DCOSGAMMAFAC_DBX, DSINGAMMAFAC_DBX, DCOS2PHI_DBX, DSIN2PHI_DBX, DCOSGAMMA_DBX
    REAL(DP)                     :: DSINGAMMAFAC_DBY, DCOSGAMMAFAC_DBY, DCOS2PHI_DBY, DSIN2PHI_DBY, DCOSGAMMA_DBY
    REAL(DP)                     :: DCOSGAMMAFAC_DBZ, DSINGAMMAFAC_DBZ, DCOS2PHI_DBZ, DSIN2PHI_DBZ, DCOSGAMMA_DBZ
    !
    CALL ABS_MAT_FIRST_STEP(L,B)
    !
    !ETAI(PIXEL_INI(L):PIXEL_END(L))=0.D0
    !ETAQ(PIXEL_INI(L):PIXEL_END(L))=0.D0
    !ETAU(PIXEL_INI(L):PIXEL_END(L))=0.D0
    !ETAV(PIXEL_INI(L):PIXEL_END(L))=0.D0
    !RHOQ(PIXEL_INI(L):PIXEL_END(L))=0.D0
    !RHOU(PIXEL_INI(L):PIXEL_END(L))=0.D0
    !RHOV(PIXEL_INI(L):PIXEL_END(L))=0.D0
    !
    !
    ! Allocate arrays for Voigt and Faraday functions
    !
    CALL ALLOCATE_1D_DP(HH,NUMWAVE(L),'HH ALLOCATION')
    CALL ALLOCATE_1D_DP(FF,NUMWAVE(L),'FF ALLOCATION')
    CALL ALLOCATE_1D_DP(UU,NUMWAVE(L),'UU ALLOCATION')
    CALL ALLOCATE_1D_DP(SHH,NUMWAVE(L),'SHH ALLOCATION')
    CALL ALLOCATE_1D_DP(SFF,NUMWAVE(L),'SFF ALLOCATION')
    !
    ! Allocate various variables for derivatives:
    CALL ALLOCATE_1D_DP(DETAI_DU, NUMWAVE(L), 'DETAI_DU ALLOCATION')
    CALL ALLOCATE_1D_DP(DETAQ_DU, NUMWAVE(L), 'DETAQ_DU ALLOCATION')
    CALL ALLOCATE_1D_DP(DETAU_DU, NUMWAVE(L), 'DETAU_DU ALLOCATION')
    CALL ALLOCATE_1D_DP(DETAV_DU, NUMWAVE(L), 'DETAV_DU ALLOCATION')
    CALL ALLOCATE_1D_DP(DRHOQ_DU, NUMWAVE(L), 'DRHOQ_DU ALLOCATION')
    CALL ALLOCATE_1D_DP(DRHOU_DU, NUMWAVE(L), 'DRHOU_DU ALLOCATION')
    CALL ALLOCATE_1D_DP(DRHOV_DU, NUMWAVE(L), 'DRHOV_DU ALLOCATION')
    CALL ALLOCATE_1D_DP(DETAI_DA, NUMWAVE(L), 'DETAI_DA ALLOCATION')
    CALL ALLOCATE_1D_DP(DETAQ_DA, NUMWAVE(L), 'DETAQ_DA ALLOCATION')
    CALL ALLOCATE_1D_DP(DETAU_DA, NUMWAVE(L), 'DETAU_DA ALLOCATION')
    CALL ALLOCATE_1D_DP(DETAV_DA, NUMWAVE(L), 'DETAV_DA ALLOCATION')
    CALL ALLOCATE_1D_DP(DRHOQ_DA, NUMWAVE(L), 'DRHOQ_DA ALLOCATION')
    CALL ALLOCATE_1D_DP(DRHOU_DA, NUMWAVE(L), 'DRHOU_DA ALLOCATION')
    CALL ALLOCATE_1D_DP(DRHOV_DA, NUMWAVE(L), 'DRHOV_DA ALLOCATION')
    CALL ALLOCATE_1D_DP(DUUDT, NUMWAVE(L), 'DUUDT ALLOCATION')
    CALL ALLOCATE_1D_DP(DH_DVDOPP, NUMWAVE(L), 'DH_DVOPP ALLOCATION')
    CALL ALLOCATE_1D_DP(DL_DDAMP, NUMWAVE(L), 'DL_DDMP ALLOCATION')
    CALL ALLOCATE_1D_DP(DH_DDAMP, NUMWAVE(L), 'DH_DDMP ALLOCATION')
    CALL ALLOCATE_1D_DP(DL_DVDOPP, NUMWAVE(L), 'DL_DVOPP ALLOCATION')
    !
    ! Doppler width of the spectral line
    ! Note:  VDOPPLER here is different from that of the module collisional_damping
    ! Here, the factor PI^(-1/2) does not appear. It is only a matter of definition
    !
    VDOPPLER=DSQRT(2.D0*KBOL*TEM(K)/(MATOM(LINE_ZN(IDL))*MAMU)) ! cm/s
    DLDOPPLER=1D3*(VDOPPLER*LINE_L0(IDL)/LIGHT)                 ! mA
    !
    ! Cartesian coordinates of the magnetic field
    !
    BBX=DBLE(BX(K))
    BBY=DBLE(BY(K))
    BBZ=DBLE(BZ(K))
    BBX2=BBX**2.D0
    BBY2=BBY**2.D0
    BBZ2=BBZ**2.D0
    BX2MBY2=BBX2-BBY2
    BX2PBY2=BBX2+BBY2
    !
    ! Magnetic field strength
    !
    BFIELD2=BBX**2.D0+BBY**2.D0+BBZ**2.D0
    BFIELD=DSQRT(BFIELD2)
    !
    ! Factors in terms of the spherical coordinates of the magnetic field
    !
    COSGAMMA=0.D0
    COSGAMMAFAC=1.D0
    SINGAMMAFAC=1.D0
    COS2PHI=0.D0
    SIN2PHI=0.D0
    SINGAMMA=0.D0
    SIN2GAMMA=0.D0
    ! Some magnetic field derivatives
    DCOSGAMMAFAC_DBX=0.D0
    DCOSGAMMAFAC_DBY=0.D0
    DCOSGAMMAFAC_DBZ=0.D0
    DSINGAMMAFAC_DBX=0.D0
    DSINGAMMAFAC_DBY=0.D0
    DSINGAMMAFAC_DBZ=0.D0
    DCOS2PHI_DBX=0.D0
    DCOS2PHI_DBY=0.D0
    DCOS2PHI_DBZ=0.D0
    DSIN2PHI_DBX=0.D0
    DSIN2PHI_DBY=0.D0
    DSIN2PHI_DBZ=0.D0
    DCOSGAMMA_DBX=0.D0
    DCOSGAMMA_DBY=0.D0
    DCOSGAMMA_DBZ=0.D0
    DB_DBX=0.D0
    DB_DBY=0.D0
    DB_DBZ=0.D0
    !
    IF (BFIELD.GT.0) THEN
       COSGAMMA=BBZ/BFIELD                              ! COS(GAMMA)
       COSGAMMAFAC=1+BBZ2/BFIELD2                       ! 1+COS(GAMMA)^2
       SINGAMMAFAC=1-BBZ2/BFIELD2                       ! SIN(GAMMA)^2
       SINGAMMA=SQRT(BBX2+BBY2)/BFIELD                  ! SIN(GAMMA)
       SIN2GAMMA=2.0*COSGAMMA*SINGAMMA                  ! SIN(2GAMMA)
       ! Some magnetic field derivatives
       DCOSGAMMAFAC_DBX=-2.E0*BBX*BBZ2/BFIELD2/BFIELD2
       DCOSGAMMAFAC_DBY=-2.E0*BBY*BBZ2/BFIELD2/BFIELD2
       DCOSGAMMAFAC_DBZ=(2.E0*BBZ*(BFIELD2-BBZ2))/BFIELD2/BFIELD2
       DSINGAMMAFAC_DBX=-DCOSGAMMAFAC_DBX
       DSINGAMMAFAC_DBY=-DCOSGAMMAFAC_DBY
       DSINGAMMAFAC_DBZ=-DCOSGAMMAFAC_DBZ
       DCOS2PHI_DBX=4.E0*BBX*BBY2/BX2PBY2/BX2PBY2
       DCOS2PHI_DBY=-4.E0*BBY*BBX2/BX2PBY2/BX2PBY2
       DCOS2PHI_DBZ=0.E0
       DSIN2PHI_DBX=-2.E0*BBY*BX2MBY2/BX2PBY2/BX2PBY2
       DSIN2PHI_DBY=2.E0*BBX*BX2MBY2/BX2PBY2/BX2PBY2
       DSIN2PHI_DBZ=0.E0
       DCOSGAMMA_DBX=-BBZ*BBX/BFIELD/BFIELD2
       DCOSGAMMA_DBY=-BBZ*BBY/BFIELD/BFIELD2
       DCOSGAMMA_DBZ=(1.E0-COSGAMMA*COSGAMMA)/BFIELD
       DB_DBX=BBX/BFIELD
       DB_DBY=BBY/BFIELD
       DB_DBZ=BBZ/BFIELD
    ENDIF
    IF (BBX.NE.0.OR.BBY.NE.0) THEN
       COS2PHI=BX2MBY2/BX2PBY2                          ! COS(2PHI)
       SIN2PHI=2.*BBX*BBY/BX2PBY2                       ! SIN(2PHI)
    ENDIF
    !
    !
    ! Checking for NaN
    !
    NAN=.FALSE.
    NAN=CHECKNAN(COSGAMMA)
    NAN=CHECKNAN(COSGAMMAFAC)
    NAN=CHECKNAN(SINGAMMAFAC)
    NAN=CHECKNAN(COS2PHI)
    NAN=CHECKNAN(SIN2PHI)
    IF (NAN.EQV..TRUE.) THEN
       PRINT*,'NaN detected in gamma,phi factors'
       PRINT*,COSGAMMA,COSGAMMAFAC,SINGAMMAFAC,COS2PHI,SIN2PHI
       PRINT*, 'B: ', DBLE(BX(K)), DBLE(BY(K)), DBLE(BZ(K)) &
           , ' ; BB: ', BBX, BBY, BBZ, ' ; BB2: ', BBX2, BBY2, BBZ2 &
           , ' ; BXY: ', BX2MBY2, BX2PBY2, ' ; B: ', BFIELD2, BFIELD
       STOP
    ENDIF
    !
    ! Initialize Zeeman pattern for spectral line L
    !
    CALL ZEEMAN_COMP(IDL)
    !
    ! DELTA_V is independent of the magnetic sublevel considered:
    DELTAL_V=-1D3*LINE_L0(IDL)*DBLE(VZ(K))/LIGHT
        ! mA (if Vz in cm/s); Vz < 0 is a blueshift
    !
    ! Derivative of UU with respect to VLOS. It is not M dependent:
    DUUDVLOS=(-1D3*LINE_L0(IDL)/LIGHT)/DLDOPPLER
    !
    ! Start loop over components of the Zeeman pattern
    !
    DO M=1,NTOT
       COUNT=1
       UU(:)=0D0
       DO N=PIXEL_INI(L),PIXEL_END(L)
          DELTAL_B=LAMBDA_SC(M)*BFIELD                       ! mA
          UU(COUNT)=DBLE((WAVE(N)-WDIF+DELTAL_B+DELTAL_V)/DLDOPPLER)
!          IF (ABS(UU(COUNT)).GT.1E4) THEN
!             PRINT*, 'UU TOO LARGE'
!             PRINT*,UU(COUNT),WAVE(N),DELTAL_B,DELTAL_V,DLDOPPLER
!             PRINT*,LINE_L0(IDL),VZ(K)
!             STOP
!          ENDIF
          NAN=.FALSE.
          NAN=CHECKNAN(DBLE(UU(COUNT)))
          IF (NAN.EQV..TRUE.) THEN
             PRINT*,'NaN detected in UU'
             PRINT*,UU(COUNT),WAVE(N)-WDIF,DELTAL_B,DELTAL_V,DLDOPPLER, VZ(K)
PRINT*, BX(K), BY(K), BZ(K), TEM(K), VZ(K), K
             STOP
          ENDIF
          COUNT=COUNT+1
       ENDDO
       NAN=.FALSE.
       NAN=CHECKNAN(DBLE(STRENGTH_SC(M)))
       IF (NAN.EQV..TRUE.) THEN
          PRINT*,'NaN detected in STRENGTH_SC'
          PRINT*,STRENGTH_SC(M),TYPE_SC(M),LAMBDA_SC(M)
          STOP
       ENDIF
       !
       ! Determine Voigt and Faraday functions
       !
       CALL VOIGT(NUMWAVE(L),DBLE(DAMP),UU,HH,FF)
       !
       ! Voight and Faraday derivatives times the Zeeman component strength:
       DH_DVDOPP=2.D0*(-UU*HH+DAMP*FF)*STRENGTH_SC(M)
       DL_DDAMP=DH_DVDOPP
       DH_DDAMP=2.D0*(-1.D0/DSQRT(DPI)+DAMP*HH+UU*FF)*STRENGTH_SC(M)
       DL_DVDOPP=-DH_DDAMP
       !
       DUUDB=LAMBDA_SC(M)/DLDOPPLER
       !
       DUUDT(:)=-0.5D0/DBLE(TEM(K))*UU(:)
       !
       !
       ! Add contribution to the different elements of the absorption matrix
       !
       SHH(:)=STRENGTH_SC(M)*HH(:)
       SFF(:)=STRENGTH_SC(M)*FF(:)
       !
       SELECT CASE(TYPE_SC(M))
       CASE(-1) ! SIGMA_RED
          ETAI(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAI(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*COSGAMMAFAC)
          ETAQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAQ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*SINGAMMAFAC*COS2PHI)
          ETAU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAU(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*SINGAMMAFAC*SIN2PHI)
          ETAV(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAV(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*COSGAMMA)
          RHOQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOQ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*SINGAMMAFAC*COS2PHI)
          RHOU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOU(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*SINGAMMAFAC*SIN2PHI)
          RHOV(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOV(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*COSGAMMA)
          !
          ! Derivatives:
          !
          ! Du
          !
          DETAI_DU(:)=0.25*DH_DVDOPP(:)*COSGAMMAFAC
          DETAQ_DU(:)=-0.25*DH_DVDOPP(:)*SINGAMMAFAC*COS2PHI
          DETAU_DU(:)=-0.25*DH_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
          DETAV_DU(:)=0.5*DH_DVDOPP(:)*COSGAMMA
          DRHOQ_DU(:)=-0.25*DL_DVDOPP(:)*SINGAMMAFAC*COS2PHI
          DRHOU_DU(:)=-0.25*DL_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
          DRHOV_DU(:)=0.5*DL_DVDOPP(:)*COSGAMMA
          !
          ! Da
          !
          DETAI_DA(:)=0.25*DH_DDAMP(:)*COSGAMMAFAC
          DETAQ_DA(:)=-0.25*DH_DDAMP(:)*SINGAMMAFAC*COS2PHI
          DETAU_DA(:)=-0.25*DH_DDAMP(:)*SINGAMMAFAC*SIN2PHI
          DETAV_DA(:)=0.50*DH_DDAMP(:)*COSGAMMA
          DRHOQ_DA(:)=-0.25*DL_DDAMP(:)*SINGAMMAFAC*COS2PHI
          DRHOU_DA(:)=-0.25*DL_DDAMP(:)*SINGAMMAFAC*SIN2PHI
          DRHOV_DA(:)=0.50*DL_DDAMP(:)*COSGAMMA
          !
          ! Dbx
          !
          DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*DCOSGAMMAFAC_DBX)
          DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
          DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
          DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*DCOSGAMMA_DBX)
          DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
          DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
          DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*DCOSGAMMA_DBX)
          !
          ! Dby
          !
          DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*DCOSGAMMAFAC_DBY)
          DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
          DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
          DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*DCOSGAMMA_DBY)
          DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
          DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
          DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*DCOSGAMMA_DBY)
          !
          ! Dbz
          !
          DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*DCOSGAMMAFAC_DBZ)
          DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
          DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
          DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*DCOSGAMMA_DBZ)
          DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
          DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
          DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*DCOSGAMMA_DBZ)
!.          !
       CASE(0) ! PI
          ETAI(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAI(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*SINGAMMAFAC)
          ETAQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAQ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*SINGAMMAFAC*COS2PHI)
          ETAU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAU(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*SINGAMMAFAC*SIN2PHI)
          RHOQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOQ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*SINGAMMAFAC*COS2PHI)
          RHOU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOU(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*SINGAMMAFAC*SIN2PHI)
          !
          ! Derivatives:
          !
          ! Du
          !
          DETAI_DU(:)=0.5*DH_DVDOPP(:)*SINGAMMAFAC
          DETAQ_DU(:)=0.5*DH_DVDOPP(:)*SINGAMMAFAC*COS2PHI
          DETAU_DU(:)=0.5*DH_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
          DRHOQ_DU(:)=0.5*DL_DVDOPP(:)*SINGAMMAFAC*COS2PHI
          DRHOU_DU(:)=0.5*DL_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
          !
          ! Da
          !
          DETAI_DA(:)=0.5*DH_DDAMP(:)*SINGAMMAFAC
          DETAQ_DA(:)=0.5*DH_DDAMP(:)*SINGAMMAFAC*COS2PHI
          DETAU_DA(:)=0.5*DH_DDAMP(:)*SINGAMMAFAC*SIN2PHI
          DRHOQ_DA(:)=0.5*DL_DDAMP(:)*SINGAMMAFAC*COS2PHI
          DRHOU_DA(:)=0.5*DL_DDAMP(:)*SINGAMMAFAC*SIN2PHI
          !
          ! Dbx
          !
          DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*DSINGAMMAFAC_DBX)
          DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
          DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
          DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
          DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
          !
          ! Dby
          !
          DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*DSINGAMMAFAC_DBY)
          DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
          DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
          DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
          DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
          !
          ! Dbz
          !
          DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*DSINGAMMAFAC_DBZ)
          DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
          DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SHH(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
          DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
          DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
              REAL(DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.5*SFF(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
!.          !
       CASE(1) ! SIGMA_BLUE
          ETAI(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAI(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*COSGAMMAFAC)
          ETAQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAQ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*SINGAMMAFAC*COS2PHI)
          ETAU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAU(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*SINGAMMAFAC*SIN2PHI)
          ETAV(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(ETAV(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SHH(:)*COSGAMMA)
          RHOQ(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOQ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*SINGAMMAFAC*COS2PHI)
          RHOU(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOU(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*SINGAMMAFAC*SIN2PHI)
          RHOV(PIXEL_INI(L):PIXEL_END(L))&
              =REAL(RHOV(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SFF(:)*COSGAMMA)
          !
          ! Derivatives:
          !
          ! Du
          !
          DETAI_DU(:)=0.25*DH_DVDOPP(:)*COSGAMMAFAC
          DETAQ_DU(:)=-0.25*DH_DVDOPP(:)*SINGAMMAFAC*COS2PHI
          DETAU_DU(:)=-0.25*DH_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
          DETAV_DU(:)=-0.5*DH_DVDOPP(:)*COSGAMMA
          DRHOQ_DU(:)=-0.25*DL_DVDOPP(:)*SINGAMMAFAC*COS2PHI
          DRHOU_DU(:)=-0.25*DL_DVDOPP(:)*SINGAMMAFAC*SIN2PHI
          DRHOV_DU(:)=-0.5*DL_DVDOPP(:)*COSGAMMA
          !
          ! Da
          !
          DETAI_DA(:)=0.25*DH_DDAMP(:)*COSGAMMAFAC
          DETAQ_DA(:)=-0.25*DH_DDAMP(:)*SINGAMMAFAC*COS2PHI
          DETAU_DA(:)=-0.25*DH_DDAMP(:)*SINGAMMAFAC*SIN2PHI
          DETAV_DA(:)=-0.50*DH_DDAMP(:)*COSGAMMA
          DRHOQ_DA(:)=-0.25*DL_DDAMP(:)*SINGAMMAFAC*COS2PHI
          DRHOU_DA(:)=-0.25*DL_DDAMP(:)*SINGAMMAFAC*SIN2PHI
          DRHOV_DA(:)=-0.50*DL_DDAMP(:)*COSGAMMA
          !
          ! Dbx
          !
          DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*DCOSGAMMAFAC_DBX)
          DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
          DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
          DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SHH(:)*DCOSGAMMA_DBX)
          DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBX*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBX))
          DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBX*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBX))
          DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SFF(:)*DCOSGAMMA_DBX)
          !
          ! Dby
          !
          DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*DCOSGAMMAFAC_DBY)
          DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
          DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
          DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SHH(:)*DCOSGAMMA_DBY)
          DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBY*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBY))
          DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBY*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBY))
          DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SFF(:)*DCOSGAMMA_DBY)
          !
          ! Dbz
          !
          DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             +0.25*SHH(:)*DCOSGAMMAFAC_DBZ)
          DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
          DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SHH(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
          DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SHH(:)*DCOSGAMMA_DBZ)
          DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBZ*COS2PHI+SINGAMMAFAC*DCOS2PHI_DBZ))
          DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.25*SFF(:)*(DSINGAMMAFAC_DBZ*SIN2PHI+SINGAMMAFAC*DSIN2PHI_DBZ))
          DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
             REAL(DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))&
             -0.5*SFF(:)*DCOSGAMMA_DBZ)
!.          !
       END SELECT
       !
       ! Dt at constant PG
       !
       DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))&
           +DETAI_DU(:)*DUUDT+DETAI_DA(:)*DDAMDTEMP_PG)
       DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))&
           +DETAQ_DU(:)*DUUDT+DETAQ_DA(:)*DDAMDTEMP_PG)
       DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))&
           +DETAU_DU(:)*DUUDT+DETAU_DA(:)*DDAMDTEMP_PG)
       DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))&
           +DETAV_DU(:)*DUUDT+DETAV_DA(:)*DDAMDTEMP_PG)
       DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOQ_DU(:)*DUUDT+DRHOQ_DA(:)*DDAMDTEMP_PG)
       DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOU_DU(:)*DUUDT+DRHOU_DA(:)*DDAMDTEMP_PG)
       DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOV_DU(:)*DUUDT+DRHOV_DA(:)*DDAMDTEMP_PG)
       !
       ! Dt at constant RHO
       !
       DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
           +DETAI_DU(:)*DUUDT+DETAI_DA(:)*DDAMDTEMP_RHO)
       DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
           +DETAQ_DU(:)*DUUDT+DETAQ_DA(:)*DDAMDTEMP_RHO)
       DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
           +DETAU_DU(:)*DUUDT+DETAU_DA(:)*DDAMDTEMP_RHO)
       DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
           +DETAV_DU(:)*DUUDT+DETAV_DA(:)*DDAMDTEMP_RHO)
       DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOQ_DU(:)*DUUDT+DRHOQ_DA(:)*DDAMDTEMP_RHO)
       DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOU_DU(:)*DUUDT+DRHOU_DA(:)*DDAMDTEMP_RHO)
       DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOV_DU(:)*DUUDT+DRHOV_DA(:)*DDAMDTEMP_RHO)
       !
       ! Dbx
       !
       DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))+DETAI_DU(:)*DUUDB*DB_DBX)
       DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))+DETAQ_DU(:)*DUUDB*DB_DBX)
       DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))+DETAU_DU(:)*DUUDB*DB_DBX)
       DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))+DETAV_DU(:)*DUUDB*DB_DBX)
       DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))+DRHOQ_DU(:)*DUUDB*DB_DBX)
       DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))+DRHOU_DU(:)*DUUDB*DB_DBX)
       DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))+DRHOV_DU(:)*DUUDB*DB_DBX)
       !
       ! Dby
       !
       DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))+DETAI_DU(:)*DUUDB*DB_DBY)
       DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))+DETAQ_DU(:)*DUUDB*DB_DBY)
       DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))+DETAU_DU(:)*DUUDB*DB_DBY)
       DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))+DETAV_DU(:)*DUUDB*DB_DBY)
       DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))+DRHOQ_DU(:)*DUUDB*DB_DBY)
       DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))+DRHOU_DU(:)*DUUDB*DB_DBY)
       DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))+DRHOV_DU(:)*DUUDB*DB_DBY)
       !
       ! Dbz
       !
       DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))+DETAI_DU(:)*DUUDB*DB_DBZ)
       DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))+DETAQ_DU(:)*DUUDB*DB_DBZ)
       DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))+DETAU_DU(:)*DUUDB*DB_DBZ)
       DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))+DETAV_DU(:)*DUUDB*DB_DBZ)
       DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))+DRHOQ_DU(:)*DUUDB*DB_DBZ)
       DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))+DRHOU_DU(:)*DUUDB*DB_DBZ)
       DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))+DRHOV_DU(:)*DUUDB*DB_DBZ)
       !
       ! Dvlos
       !
       DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DETAI_DU(:)*DUUDVLOS)
       DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DETAQ_DU(:)*DUUDVLOS)
       DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DETAU_DU(:)*DUUDVLOS)
       DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DETAV_DU(:)*DUUDVLOS)
       DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DRHOQ_DU(:)*DUUDVLOS)
       DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DRHOU_DU(:)*DUUDVLOS)
       DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))+DRHOV_DU(:)*DUUDVLOS)
       !
       ! Dpg
       !
       DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))&
           +DETAI_DA(:))
       DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))&
           +DETAQ_DA(:))
       DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))&
           +DETAU_DA(:))
       DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))&
           +DETAV_DA(:))
       DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOQ_DA(:))
       DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOU_DA(:))
       DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOV_DA(:))
       !
       ! Drho
       !
       DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L))&
           +DETAI_DA(:))
       DETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))&
           +DETAQ_DA(:))
       DETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L))&
           +DETAU_DA(:))
       DETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L))&
           +DETAV_DA(:))
       DRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOQ_DA(:))
       DRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOU_DA(:))
       DRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L))=&
           REAL(DRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L))&
           +DRHOV_DA(:))
       !
       HH(:)=0D0
       FF(:)=0D0
       SHH(:)=0D0
       SFF(:)=0D0
       !
       DETAI_DU(:)=0.D0
       DETAV_DU(:)=0.D0
       DETAQ_DU(:)=0.D0
       DETAU_DU(:)=0.D0
       DRHOV_DU(:)=0.D0
       DRHOQ_DU(:)=0.D0
       DRHOU_DU(:)=0.D0
       !
       DETAI_DA(:)=0.D0
       DETAV_DA(:)=0.D0
       DETAQ_DA(:)=0.D0
       DETAU_DA(:)=0.D0
       DRHOV_DA(:)=0.D0
       DRHOQ_DA(:)=0.D0
       DRHOU_DA(:)=0.D0
       !
    ENDDO
    !
    ! Dt at constant PG
    ! WARNING! It is important to have these lines before the various ETAs and RHOs statements!
    !
    DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
        DKCDTEMP_PG&
        +DKLDTEMP_PG*ETAI(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAI_DTPG(PIXEL_INI(L):PIXEL_END(L))
    DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_PG*ETAQ(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAQ_DTPG(PIXEL_INI(L):PIXEL_END(L))
    DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_PG*ETAU(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAU_DTPG(PIXEL_INI(L):PIXEL_END(L))
    DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_PG*ETAV(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAV_DTPG(PIXEL_INI(L):PIXEL_END(L))
    DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_PG*RHOQ(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOQ_DTPG(PIXEL_INI(L):PIXEL_END(L))
    DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_PG*RHOU(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOU_DTPG(PIXEL_INI(L):PIXEL_END(L))
    DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_PG*RHOV(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOV_DTPG(PIXEL_INI(L):PIXEL_END(L))
    !
    ! Dt at constant RHO
    ! WARNING! It is important to have these lines before the various ETAs and RHOs statements!
    !
    DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
        DKCDTEMP_RHO&
        +DKLDTEMP_RHO*ETAI(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAI_DTRHO(PIXEL_INI(L):PIXEL_END(L))
    DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_RHO*ETAQ(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))
    DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_RHO*ETAU(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAU_DTRHO(PIXEL_INI(L):PIXEL_END(L))
    DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_RHO*ETAV(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAV_DTRHO(PIXEL_INI(L):PIXEL_END(L))
    DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_RHO*RHOQ(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOQ_DTRHO(PIXEL_INI(L):PIXEL_END(L))
    DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_RHO*RHOU(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOU_DTRHO(PIXEL_INI(L):PIXEL_END(L))
    DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))=&
        DKLDTEMP_RHO*RHOV(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOV_DTRHO(PIXEL_INI(L):PIXEL_END(L))
    !
    ! Dpg
    !
    DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKCDPG_TEMP&
        +DKLDPG_TEMP*ETAI(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAI_DPGT(PIXEL_INI(L):PIXEL_END(L))&
        *DDAMDPG_TEMP)
    DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDPG_TEMP*ETAQ(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAQ_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
    DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDPG_TEMP*ETAU(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAU_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
    DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDPG_TEMP*ETAV(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAV_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
    DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDPG_TEMP*RHOQ(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOQ_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
    DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDPG_TEMP*RHOU(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOU_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
    DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDPG_TEMP*RHOV(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOV_DPGT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDPG_TEMP)
    !
    ! Drho
    !
    DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKCDRHO_TEMP&
        +DKLDRHO_TEMP*ETAI(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAI_DRHOT(PIXEL_INI(L):PIXEL_END(L))&
        *DDAMDRHO_TEMP)
    DETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDRHO_TEMP*ETAQ(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAQ_DRHOT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDRHO_TEMP)
    DETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDRHO_TEMP*ETAU(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAU_DRHOT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDRHO_TEMP)
    DETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDRHO_TEMP*ETAV(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DETAV_DRHOT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDRHO_TEMP)
    DRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDRHO_TEMP*RHOQ(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOQ_DRHOT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDRHO_TEMP)
    DRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDRHO_TEMP*RHOU(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOU_DRHOT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDRHO_TEMP)
    DRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L))=REAL(&
        DKLDRHO_TEMP*RHOV(PIXEL_INI(L):PIXEL_END(L))&
        +KLIN(L,B)*DRHOV_DRHOT(PIXEL_INI(L):PIXEL_END(L)) * DDAMDRHO_TEMP)
    !
    !
    ! Add line and continuum contribution
    !
    ETAI(PIXEL_INI(L):PIXEL_END(L))=KC(L)+KLIN(L,B)&
        *ETAI(PIXEL_INI(L):PIXEL_END(L))
    ETAV(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *ETAV(PIXEL_INI(L):PIXEL_END(L))
    ETAQ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *ETAQ(PIXEL_INI(L):PIXEL_END(L))
    ETAU(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *ETAU(PIXEL_INI(L):PIXEL_END(L))
    RHOV(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *RHOV(PIXEL_INI(L):PIXEL_END(L))
    RHOQ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *RHOQ(PIXEL_INI(L):PIXEL_END(L))
    RHOU(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)&
        *RHOU(PIXEL_INI(L):PIXEL_END(L))
    !
    ! Derivatives:
    !
    ! Dbx
    !
    DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAI_DBX(PIXEL_INI(L):PIXEL_END(L))
    DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAQ_DBX(PIXEL_INI(L):PIXEL_END(L))
    DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAU_DBX(PIXEL_INI(L):PIXEL_END(L))
    DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAV_DBX(PIXEL_INI(L):PIXEL_END(L))
    DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOQ_DBX(PIXEL_INI(L):PIXEL_END(L))
    DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOU_DBX(PIXEL_INI(L):PIXEL_END(L))
    DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOV_DBX(PIXEL_INI(L):PIXEL_END(L))
    !
    ! Dby
    !
    DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAI_DBY(PIXEL_INI(L):PIXEL_END(L))
    DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAQ_DBY(PIXEL_INI(L):PIXEL_END(L))
    DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAU_DBY(PIXEL_INI(L):PIXEL_END(L))
    DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAV_DBY(PIXEL_INI(L):PIXEL_END(L))
    DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOQ_DBY(PIXEL_INI(L):PIXEL_END(L))
    DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOU_DBY(PIXEL_INI(L):PIXEL_END(L))
    DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOV_DBY(PIXEL_INI(L):PIXEL_END(L))
    !
    ! Dbz
    !
    DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAI_DBZ(PIXEL_INI(L):PIXEL_END(L))
    DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAQ_DBZ(PIXEL_INI(L):PIXEL_END(L))
    DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAU_DBZ(PIXEL_INI(L):PIXEL_END(L))
    DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAV_DBZ(PIXEL_INI(L):PIXEL_END(L))
    DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOQ_DBZ(PIXEL_INI(L):PIXEL_END(L))
    DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOU_DBZ(PIXEL_INI(L):PIXEL_END(L))
    DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOV_DBZ(PIXEL_INI(L):PIXEL_END(L))
    !
    ! Dvlos
    !
    DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAI_DVLOS(PIXEL_INI(L):PIXEL_END(L))
    DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))
    DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAU_DVLOS(PIXEL_INI(L):PIXEL_END(L))
    DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DETAV_DVLOS(PIXEL_INI(L):PIXEL_END(L))
    DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOQ_DVLOS(PIXEL_INI(L):PIXEL_END(L))
    DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOU_DVLOS(PIXEL_INI(L):PIXEL_END(L))
    DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))=KLIN(L,B)*DRHOV_DVLOS(PIXEL_INI(L):PIXEL_END(L))
    !
    DEALLOCATE(HH, FF, UU)
    DEALLOCATE(SHH, SFF)
    DEALLOCATE(TYPE_SC, LAMBDA_SC, STRENGTH_SC)
    !
    DEALLOCATE(DUUDT)
    DEALLOCATE(DETAI_DU, DETAV_DU, DETAQ_DU, DETAU_DU, DRHOV_DU, DRHOQ_DU, DRHOU_DU)
    DEALLOCATE(DETAI_DA, DETAQ_DA, DETAU_DA, DETAV_DA, DRHOQ_DA, DRHOU_DA, DRHOV_DA)
    DEALLOCATE(DH_DVDOPP, DL_DDAMP, DH_DDAMP, DL_DVDOPP)
    !
    CALL ABS_MAT_END_STEP(L,B)
    !
  END SUBROUTINE GET_ABS_MAT_WDEV
  !
  !------------------------------------------------
  !
  SUBROUTINE ABS_MAT_END()
    !
    DEALLOCATE(ETAI)
    DEALLOCATE(ETAQ)
    DEALLOCATE(ETAU)
    DEALLOCATE(ETAV)
    DEALLOCATE(RHOQ)
    DEALLOCATE(RHOU)
    DEALLOCATE(RHOV)
    !
    DEALLOCATE(IETAI)
    DEALLOCATE(IETAQ)
    DEALLOCATE(IETAU)
    DEALLOCATE(IETAV)
    DEALLOCATE(IRHOQ)
    DEALLOCATE(IRHOU)
    DEALLOCATE(IRHOV)
    !
    !DERIVATIVES:
    !
    IF (MRESPFUNCT.EQV..TRUE.) THEN
      !
      ! Dbx
      !
      DEALLOCATE(DETAI_DBX)
      DEALLOCATE(DETAQ_DBX)
      DEALLOCATE(DETAU_DBX)
      DEALLOCATE(DETAV_DBX)
      DEALLOCATE(DRHOQ_DBX)
      DEALLOCATE(DRHOU_DBX)
      DEALLOCATE(DRHOV_DBX)
      !
      ! Dby
      !
      DEALLOCATE(DETAI_DBY)
      DEALLOCATE(DETAQ_DBY)
      DEALLOCATE(DETAU_DBY)
      DEALLOCATE(DETAV_DBY)
      DEALLOCATE(DRHOQ_DBY)
      DEALLOCATE(DRHOU_DBY)
      DEALLOCATE(DRHOV_DBY)
      !
      ! Dbz
      !
      DEALLOCATE(DETAI_DBZ)
      DEALLOCATE(DETAQ_DBZ)
      DEALLOCATE(DETAU_DBZ)
      DEALLOCATE(DETAV_DBZ)
      DEALLOCATE(DRHOQ_DBZ)
      DEALLOCATE(DRHOU_DBZ)
      DEALLOCATE(DRHOV_DBZ)
      !
      ! Dvlos
      !
      DEALLOCATE(DETAI_DVLOS)
      DEALLOCATE(DETAQ_DVLOS)
      DEALLOCATE(DETAU_DVLOS)
      DEALLOCATE(DETAV_DVLOS)
      DEALLOCATE(DRHOQ_DVLOS)
      DEALLOCATE(DRHOU_DVLOS)
      DEALLOCATE(DRHOV_DVLOS)
      !
      ! Dt at constant PG
      !
      DEALLOCATE(DETAI_DTPG)
      DEALLOCATE(DETAQ_DTPG)
      DEALLOCATE(DETAU_DTPG)
      DEALLOCATE(DETAV_DTPG)
      DEALLOCATE(DRHOQ_DTPG)
      DEALLOCATE(DRHOU_DTPG)
      DEALLOCATE(DRHOV_DTPG)
      !
      !
      ! Dt at constant RHO
      !
      DEALLOCATE(DETAI_DTRHO)
      DEALLOCATE(DETAQ_DTRHO)
      DEALLOCATE(DETAU_DTRHO)
      DEALLOCATE(DETAV_DTRHO)
      DEALLOCATE(DRHOQ_DTRHO)
      DEALLOCATE(DRHOU_DTRHO)
      DEALLOCATE(DRHOV_DTRHO)
      !
      ! Dpg at constant T
      !
      DEALLOCATE(DETAI_DPGT)
      DEALLOCATE(DETAQ_DPGT)
      DEALLOCATE(DETAU_DPGT)
      DEALLOCATE(DETAV_DPGT)
      DEALLOCATE(DRHOQ_DPGT)
      DEALLOCATE(DRHOU_DPGT)
      DEALLOCATE(DRHOV_DPGT)
      !
      ! Drho at constant T
      !
      DEALLOCATE(DETAI_DRHOT)
      DEALLOCATE(DETAQ_DRHOT)
      DEALLOCATE(DETAU_DRHOT)
      DEALLOCATE(DETAV_DRHOT)
      DEALLOCATE(DRHOQ_DRHOT)
      DEALLOCATE(DRHOU_DRHOT)
      DEALLOCATE(DRHOV_DRHOT)
      !
      ! I Terms:
      !
      ! Dbx
      !
      DEALLOCATE(DIETAI_DBX)
      DEALLOCATE(DIETAQ_DBX)
      DEALLOCATE(DIETAU_DBX)
      DEALLOCATE(DIETAV_DBX)
      DEALLOCATE(DIRHOQ_DBX)
      DEALLOCATE(DIRHOU_DBX)
      DEALLOCATE(DIRHOV_DBX)
      !
      ! Dby
      !
      DEALLOCATE(DIETAI_DBY)
      DEALLOCATE(DIETAQ_DBY)
      DEALLOCATE(DIETAU_DBY)
      DEALLOCATE(DIETAV_DBY)
      DEALLOCATE(DIRHOQ_DBY)
      DEALLOCATE(DIRHOU_DBY)
      DEALLOCATE(DIRHOV_DBY)
      !
      ! Dbz
      !
      DEALLOCATE(DIETAI_DBZ)
      DEALLOCATE(DIETAQ_DBZ)
      DEALLOCATE(DIETAU_DBZ)
      DEALLOCATE(DIETAV_DBZ)
      DEALLOCATE(DIRHOQ_DBZ)
      DEALLOCATE(DIRHOU_DBZ)
      DEALLOCATE(DIRHOV_DBZ)
      !
      ! Dvlos
      !
      DEALLOCATE(DIETAI_DVLOS)
      DEALLOCATE(DIETAQ_DVLOS)
      DEALLOCATE(DIETAU_DVLOS)
      DEALLOCATE(DIETAV_DVLOS)
      DEALLOCATE(DIRHOQ_DVLOS)
      DEALLOCATE(DIRHOU_DVLOS)
      DEALLOCATE(DIRHOV_DVLOS)
      !
      ! Dt at constant PG
      !
      DEALLOCATE(DIETAI_DTPG)
      DEALLOCATE(DIETAQ_DTPG)
      DEALLOCATE(DIETAU_DTPG)
      DEALLOCATE(DIETAV_DTPG)
      DEALLOCATE(DIRHOQ_DTPG)
      DEALLOCATE(DIRHOU_DTPG)
      DEALLOCATE(DIRHOV_DTPG)
      !
      ! Dt at constant RHO
      !
      DEALLOCATE(DIETAI_DTRHO)
      DEALLOCATE(DIETAQ_DTRHO)
      DEALLOCATE(DIETAU_DTRHO)
      DEALLOCATE(DIETAV_DTRHO)
      DEALLOCATE(DIRHOQ_DTRHO)
      DEALLOCATE(DIRHOU_DTRHO)
      DEALLOCATE(DIRHOV_DTRHO)
      !
      ! Dpg at constant T
      !
      DEALLOCATE(DIETAI_DPGT)
      DEALLOCATE(DIETAQ_DPGT)
      DEALLOCATE(DIETAU_DPGT)
      DEALLOCATE(DIETAV_DPGT)
      DEALLOCATE(DIRHOQ_DPGT)
      DEALLOCATE(DIRHOU_DPGT)
      DEALLOCATE(DIRHOV_DPGT)
      !
      ! Drho at constant T
      !
      DEALLOCATE(DIETAI_DRHOT)
      DEALLOCATE(DIETAQ_DRHOT)
      DEALLOCATE(DIETAU_DRHOT)
      DEALLOCATE(DIETAV_DRHOT)
      DEALLOCATE(DIRHOQ_DRHOT)
      DEALLOCATE(DIRHOU_DRHOT)
      DEALLOCATE(DIRHOV_DRHOT)
      !
    ENDIF
    !
  END SUBROUTINE ABS_MAT_END
  !
  !================================================
  !
END MODULE ABSORPTION_MATRIX
!
