!
MODULE NORMALIZATION
  !
  !================================================
  !
  USE CONS_PARAM, ONLY: SP, DP, HPLA, LIGHT, KBOL, IMAT
  USE FORWARD_PARAM, ONLY: NUML, NUMW, IND_LINE &
      , PIXEL_INI, PIXEL_END, WAVE, LINE_L0
  USE CHEMICAL_EQUILIBRIUM, ONLY: GET_NHNEMU_G
  USE ALLOCATE_UTILS, ONLY: ALLOCATE_1D_SP, ALLOCATE_2D_DP
  !
  IMPLICIT NONE
  !
  !::::::::::::::::::::::::::::::::::::::::::::::::
  !
  INTEGER, PARAMETER            :: HSRA_LEN=387
  !
  REAL(SP), ALLOCATABLE  :: HSRA_TEM(:), HSRA_PG(:), HSRA_RHO(:)
  REAL(SP), ALLOCATABLE  :: HSRA_BX(:), HSRA_BY(:), HSRA_BZ(:)
  REAL(SP), ALLOCATABLE  :: HSRA_PEL(:), HSRA_MW(:), HSRA_Z(:), HSRA_VZ(:)
  !
  REAL(DP), ALLOCATABLE  :: HSRA_ETAI(:,:)
  REAL(DP), ALLOCATABLE  :: HSRA_ETAQ(:,:),HSRA_ETAU(:,:),HSRA_ETAV(:,:)
  REAL(DP), ALLOCATABLE  :: HSRA_RHOQ(:,:),HSRA_RHOU(:,:),HSRA_RHOV(:,:)
  !
  REAL(DP), ALLOCATABLE  :: HSRA_KC(:,:)
  !
  REAL(DP), ALLOCATABLE  :: HSRA_SYN(:,:)
  !
  PUBLIC :: GET_NORM
  PRIVATE
  !
  !************************************************
  !
  CONTAINS
  !
  ! set_hsra_model_old
  ! set_hsra_model
  ! deallocate_hsra_model
  ! hsra_vars
  ! deallocate_hsra_vars
  ! get_abs_mat_hsra
  ! analytical_solver_hsra
  ! evol_operator_hsra
  ! source_function_hsra
  ! set_boundary_hsra
  ! get_norm
  !
  !------------------------------------------------
  !
  SUBROUTINE SET_HSRA_MODEL_OLD
    !
    CALL ALLOCATE_1D_SP(HSRA_TEM,HSRA_LEN,'HSRA_TEM')
    CALL ALLOCATE_1D_SP(HSRA_PG,HSRA_LEN,'HSRA_PG')
    CALL ALLOCATE_1D_SP(HSRA_RHO,HSRA_LEN,'HSRA_RHO')
    CALL ALLOCATE_1D_SP(HSRA_BX,HSRA_LEN,'HSRA_BX')
    CALL ALLOCATE_1D_SP(HSRA_BY,HSRA_LEN,'HSRA_BY')
    CALL ALLOCATE_1D_SP(HSRA_BZ,HSRA_LEN,'HSRA_BZ')
    CALL ALLOCATE_1D_SP(HSRA_VZ,HSRA_LEN,'HSRA_VZ')
    CALL ALLOCATE_1D_SP(HSRA_PEL,HSRA_LEN,'HSRA_PEL')
    CALL ALLOCATE_1D_SP(HSRA_MW,HSRA_LEN,'HSRA_MW')
    CALL ALLOCATE_1D_SP(HSRA_Z,HSRA_LEN,'HSRA_Z')
    !
    HSRA_TEM(:)=(/9560.00,9390.00,9220.00,9050.00,8880.00,8710.00,8520.00,&
        8290.00,8030.00,7750.00,7440.00,7140.00,6860.00,6610.00,6390.00,&
        6200.00,6035.00,5890.00,5765.00,5650.00,5540.00,5430.00,5330.00,&
        5240.00,5160.00,5080.00,5010.00,4950.00,4895.00,4840.00,4790.00,&
        4750.00,4720.00,4690.00,4660.00,4630.00,4600.00,4575.00,4550.00,&
        4525.00,4490.00,4460.00,4430.00,4405.00,4380.00,4355.00,4330.00,&
        4305.00,4280.00,4250.00,4225.00,4205.00,4190.00,4175.00,4170.00,&
        4200.00,4280.00,4400.00,4530.00,4660.00,4790.00,4910.00,5040.00,&
        5170.00,5300.00,5440.00,5590.00,5750.00,5950.00,6180.00,6440.00,&
        6720.00,6970.00,7180.00,7360.00,7500.00,7630.00,7710.00,7820.00,&
        7910.00,8000.00,8090.00,8170.00,8250.00,8320.00,8380.00,8450.00,&
        8510.00,8560.00,8630.00,8680.00,8750.00,8810.00,8880.00,8980.00/)
    HSRA_PG(:)=(/2.0530e+05,2.0010e+05,1.9510e+05,1.9040e+05,1.8590e+05,&
        1.8170e+05,1.7760e+05,1.7360e+05,1.6940e+05,1.6480e+05,1.5980e+05,&
        1.5400e+05,1.4720e+05,1.3950e+05,1.3100e+05,1.2170e+05,1.1200e+05,&
        1.0210e+05,9.2440e+04,8.3110e+04,7.4300e+04,6.6080e+04,5.5400e+04,&
        5.1720e+04,4.5620e+04,4.0200e+04,3.5400e+04,3.1160e+04,2.7420e+04,&
        2.4120e+04,2.1220e+04,1.8670e+04,1.6420e+04,1.4440e+04,1.2690e+04,&
        1.1160e+04,9.8070e+03,8.6180e+03,7.5710e+03,6.6500e+03,5.8390e+03,&
        5.1250e+03,4.4970e+03,3.9440e+03,3.4570e+03,3.0280e+03,2.6510e+03,&
        2.3190e+03,2.0260e+03,1.7680e+03,1.5410e+03,1.3400e+03,1.1630e+03,&
        1.0070e+03,8.6820e+02,7.4520e+02,6.3420e+02,5.3070e+02,4.3140e+02,&
        3.3750e+02,2.5440e+02,1.8660e+02,1.3460e+02,9.6490e+01,6.7900e+01,&
        4.6110e+01,2.9160e+01,1.6550e+01,8.2250e+00,3.7930e+00,1.8120e+00,&
        1.0030e+00,6.5120e-01,4.7360e-01,3.7630e-01,3.1650e-01,2.7620e-01,&
        2.4750e-01,2.2610e-01,2.0990e-01,1.9730e-01,1.8750e-01,1.7980e-01,&
        1.7370e-01,1.6890e-01,1.6500e-01,1.6190e-01,1.5940e-01,1.5750e-01,&
        1.5590e-01,1.5470e-01,1.5370e-01,1.5290e-01,1.5230e-01,1.5180e-01/)
    HSRA_RHO(:)=(/3.2500e-07,3.2400e-07,3.2300e-07,3.2200e-07,3.2100e-07,&
        3.2100e-07,3.2200e-07,3.2400e-07,3.2700e-07,3.3000e-07,3.3400e-07,&
        3.3600e-07,3.3400e-07,3.2900e-07,3.1900e-07,3.0600e-07,2.8900e-07,&
        2.7000e-07,2.5000e-07,2.2900e-07,2.0900e-07,1.9000e-07,1.7100e-07,&
        1.5400e-07,1.3800e-07,1.2300e-07,1.1000e-07,9.8100e-08,8.7300e-08,&
        7.7700e-08,6.9100e-08,6.1300e-08,5.4200e-08,4.8000e-08,4.2500e-08,&
        3.7600e-08,3.3200e-08,2.9400e-08,2.5900e-08,2.2900e-08,2.0300e-08,&
        1.7900e-08,1.5800e-08,1.4000e-08,1.2300e-08,1.0800e-08,9.5400e-09,&
        8.4000e-09,7.3800e-09,6.4800e-09,5.6800e-09,4.9700e-09,4.3300e-09,&
        3.7600e-09,3.2400e-09,2.7600e-09,2.3100e-09,1.8800e-09,1.4800e-09,&
        1.1300e-09,8.2800e-10,5.9200e-10,4.1600e-10,2.9100e-10,1.9900e-10,&
        1.3200e-10,8.1100e-11,4.4700e-11,2.1400e-11,9.4100e-12,4.2300e-12,&
        2.1700e-12,1.2900e-12,8.6500e-13,6.3100e-13,4.9900e-13,4.1100e-13,&
        3.5800e-13,3.1600e-13,2.8700e-13,2.6500e-13,2.4800e-13,2.3400e-13,&
        2.2400e-13,2.1600e-13,2.1000e-13,2.0500e-13,2.0000e-13,1.9700e-13,&
        1.9300e-13,1.9100e-13,1.8800e-13,1.8500e-13,1.8200e-13,1.8100e-13/)
    HSRA_BX(:)=HSRA_TEM*0.
    HSRA_BY(:)=HSRA_TEM*0.
    HSRA_BZ(:)=HSRA_TEM*0.
    HSRA_VZ(:)=HSRA_TEM*0.
    !
    HSRA_PEL(:)=HSRA_TEM*0.
    HSRA_MW(:)=HSRA_TEM*0.
    HSRA_Z(:)=(/-82.6000,-76.7000,-71.1000,-65.8000,-60.8000,-56.0000,&
        -51.4000,-46.8000,-42.1000,-37.1000,-31.6000,-25.3000,-18.0000,&
        -9.5900,0.0000,10.8000,22.6000,35.4000,48.9000,63.1000,77.7000,&
        92.6000,108.0000,123.0000,138.0000,153.0000,168.0000,183.0000,&
        198.0000,212.0000,227.0000,241.0000,255.0000,269.0000,283.0000,&
        297.0000,311.0000,325.0000,339.0000,352.0000,366.0000,379.0000,&
        393.0000,407.0000,420.0000,433.0000,447.0000,460.0000,474.0000,&
        487.0000,501.0000,515.0000,529.0000,543.0000,557.0000,572.0000,&
        588.0000,606.0000,627.0000,654.0000,685.0000,720.0000,758.0000,&
        797.0000,840.0000,888.0000,947.0000,1020.0000,1120.0000,1230.0000,&
        1340.0000,1430.0000,1510.0000,1570.0000,1620.0000,1660.0000,&
        1690.0000,1720.0000,1740.0000,1760.0000,1780.0000,1790.0000,&
        1800.0000,1810.0000,1820.0000,1830.0000,1835.0000,1840.0000,&
        1850.0000,1860.0000,1870.0000,1880.0000,1890.0000,1900.0000,&
        1910.0000/)
    !
  END SUBROUTINE SET_HSRA_MODEL_OLD
  !
  !------------------------------------------------
  !
  SUBROUTINE SET_HSRA_MODEL
    !
    CALL ALLOCATE_1D_SP(HSRA_TEM,HSRA_LEN,'HSRA_TEM')
    CALL ALLOCATE_1D_SP(HSRA_PG,HSRA_LEN,'HSRA_PG')
    CALL ALLOCATE_1D_SP(HSRA_RHO,HSRA_LEN,'HSRA_RHO')
    CALL ALLOCATE_1D_SP(HSRA_BX,HSRA_LEN,'HSRA_BX')
    CALL ALLOCATE_1D_SP(HSRA_BY,HSRA_LEN,'HSRA_BY')
    CALL ALLOCATE_1D_SP(HSRA_BZ,HSRA_LEN,'HSRA_BZ')
    CALL ALLOCATE_1D_SP(HSRA_VZ,HSRA_LEN,'HSRA_VZ')
    CALL ALLOCATE_1D_SP(HSRA_PEL,HSRA_LEN,'HSRA_PEL')
    CALL ALLOCATE_1D_SP(HSRA_MW,HSRA_LEN,'HSRA_MW')
    CALL ALLOCATE_1D_SP(HSRA_Z,HSRA_LEN,'HSRA_Z')
    !
    HSRA_TEM(:)=(/9560.00,9415.22,9264.03,9105.34,8937.82,8762.26,8563.40,&
        8321.30,8046.65,7765.47,7482.35,7236.50,7024.99,6838.50,6689.13,&
        6555.79,6440.52,6340.34,6251.94,6171.02,6100.76,6031.35,5974.43,&
        5917.50,5865.95,5819.43,5772.90,5731.22,5690.52,5649.84,5611.98,&
        5574.12,5536.34,5499.24,5462.15,5425.65,5393.02,5360.39,5327.93,&
        5297.78,5267.63,5237.76,5210.96,5184.16,5157.36,5130.56,5103.77,&
        5077.35,5053.90,5030.45,5007.43,4987.33,4967.23,4947.37,4928.94,&
        4910.52,4891.89,4872.15,4852.40,4833.78,4817.03,4800.28,4784.45,&
        4770.09,4755.74,4743.54,4732.77,4722.00,4711.23,4700.47,4689.70,&
        4678.93,4668.16,4657.40,4646.63,4635.86,4625.09,4614.32,4603.56,&
        4593.99,4585.02,4576.05,4567.07,4558.10,4549.06,4539.40,4529.73,&
        4518.59,4506.03,4493.47,4481.60,4470.01,4458.53,4447.76,4436.99,&
        4426.85,4417.88,4408.91,4399.54,4389.88,4380.22,4370.55,4360.89,&
        4351.50,4342.52,4333.55,4324.16,4314.50,4304.85,4295.87,4286.90,&
        4277.32,4265.73,4254.13,4244.22,4235.25,4226.28,4218.84,4211.66,&
        4204.61,4199.23,4193.85,4188.46,4183.08,4177.70,4174.10,4172.31,&
        4170.51,4177.17,4187.22,4197.27,4218.29,4243.41,4268.54,4298.22,&
        4331.72,4365.22,4398.72,4429.91,4461.02,4492.13,4523.23,4548.93,&
        4573.12,4597.32,4621.51,4645.71,4668.62,4689.69,4710.77,4731.84,&
        4752.91,4773.98,4794.13,4811.36,4828.59,4845.82,4863.04,4880.27,&
        4897.50,4914.72,4931.91,4949.10,4966.29,4983.48,5000.67,5017.86,&
        5035.05,5051.93,5068.68,5085.43,5102.18,5118.93,5135.68,5152.42,&
        5169.17,5184.44,5199.63,5214.83,5230.02,5245.21,5260.40,5275.59,&
        5290.78,5305.76,5320.42,5335.08,5349.73,5364.39,5379.04,5393.70,&
        5408.35,5423.01,5437.67,5450.74,5463.52,5476.29,5489.07,5501.84,&
        5514.62,5527.39,5540.17,5552.94,5565.72,5578.49,5591.09,5602.11,&
        5613.12,5624.13,5635.15,5646.16,5657.17,5668.19,5679.20,5690.21,&
        5701.23,5712.24,5723.25,5734.27,5745.28,5755.74,5765.79,5775.84,&
        5785.89,5795.94,5805.99,5816.04,5826.09,5836.14,5846.19,5856.24,&
        5866.29,5876.34,5886.39,5896.44,5906.49,5916.54,5926.59,5936.64,&
        5946.69,5957.04,5967.55,5978.06,5988.56,5999.07,6009.58,6020.08,&
        6030.59,6041.10,6051.60,6062.11,6072.62,6083.12,6093.63,6104.14,&
        6114.64,6125.15,6135.66,6146.16,6156.67,6167.18,6177.68,6189.26,&
        6201.13,6213.01,6224.89,6236.76,6248.64,6260.52,6272.39,6284.27,&
        6296.15,6308.03,6319.90,6331.78,6343.66,6355.53,6367.41,6379.29,&
        6391.16,6403.04,6414.92,6426.80,6438.67,6453.89,6469.52,6485.15,&
        6500.78,6516.42,6532.05,6547.68,6563.32,6578.95,6594.58,6610.21,&
        6625.85,6641.48,6657.11,6672.75,6688.38,6704.01,6719.65,6735.35,&
        6751.05,6766.75,6782.45,6798.16,6813.86,6829.56,6845.27,6860.97,&
        6876.67,6892.37,6908.08,6923.78,6939.48,6955.18,6970.99,6988.58,&
        7006.17,7023.75,7041.34,7058.93,7076.52,7094.10,7111.69,7129.28,&
        7146.86,7164.45,7182.10,7200.19,7218.28,7236.37,7254.45,7272.54,&
        7290.63,7308.72,7326.81,7344.90,7362.91,7380.50,7398.08,7415.67,&
        7433.26,7450.84,7468.43,7486.02,7504.46,7526.24,7548.01,7569.79,&
        7591.56,7613.34,7633.14,7646.54,7659.94,7673.34,7686.74,7700.14,&
        7717.31,7744.94,7772.58,7800.22,7826.43,7849.04,7871.65,7894.26,&
        7916.87,7939.49,7962.10,7984.71,8014.64,8059.87,8103.41,8143.61,&
        8183.81,8224.01,8262.43,8297.61,8330.96,8361.10,8455.84,8489.34,&
        8558.13,8714.42,8773.70,8980.00/)
    HSRA_PG(:)=(/2.0530e+05,2.0087e+05,1.9639e+05,1.9193e+05,1.8743e+05,&
        1.8299e+05,1.7854e+05,1.7414e+05,1.6967e+05,1.6505e+05,1.6048e+05,&
        1.5587e+05,1.5121e+05,1.4654e+05,1.4194e+05,1.3741e+05,1.3295e+05,&
        1.2857e+05,1.2424e+05,1.2000e+05,1.1587e+05,1.1175e+05,1.0786e+05,&
        1.0398e+05,1.0024e+05,9.6646e+04,9.3051e+04,8.9699e+04,8.6398e+04,&
        8.3097e+04,8.0065e+04,7.7033e+04,7.4026e+04,7.1254e+04,6.8482e+04,&
        6.5615e+04,6.2130e+04,5.8645e+04,5.5315e+04,5.4083e+04,5.2850e+04,&
        5.1549e+04,4.9506e+04,4.7462e+04,4.5441e+04,4.3626e+04,4.1810e+04,&
        4.0018e+04,3.8410e+04,3.6802e+04,3.5218e+04,3.3798e+04,3.2377e+04,&
        3.0981e+04,2.9728e+04,2.8475e+04,2.7233e+04,2.6049e+04,2.4864e+04,&
        2.3759e+04,2.2788e+04,2.1816e+04,2.0866e+04,1.9951e+04,1.9036e+04,&
        1.8185e+04,1.7378e+04,1.6570e+04,1.5841e+04,1.5131e+04,1.4422e+04,&
        1.3794e+04,1.3166e+04,1.2557e+04,1.2008e+04,1.1459e+04,1.0939e+04,&
        1.0453e+04,9.9674e+03,9.5212e+03,9.0945e+03,8.6677e+03,8.2860e+03,&
        7.9102e+03,7.5363e+03,7.1804e+03,6.8244e+03,6.5015e+03,6.2104e+03,&
        5.9193e+03,5.6392e+03,5.3632e+03,5.0941e+03,4.8687e+03,4.6433e+03,&
        4.4274e+03,4.2289e+03,4.0304e+03,3.8377e+03,3.6495e+03,3.4612e+03,&
        3.2949e+03,3.1291e+03,2.9752e+03,2.8399e+03,2.7046e+03,2.5735e+03,&
        2.4451e+03,2.3172e+03,2.2120e+03,2.1069e+03,2.0030e+03,1.9032e+03,&
        1.8035e+03,1.7155e+03,1.6341e+03,1.5526e+03,1.4791e+03,1.4070e+03,&
        1.3355e+03,1.2719e+03,1.2084e+03,1.1470e+03,1.0910e+03,1.0350e+03,&
        9.8213e+02,9.3231e+02,8.8249e+02,8.3882e+02,7.9761e+02,7.5641e+02,&
        7.1982e+02,6.8496e+02,6.5010e+02,6.1849e+02,5.8959e+02,5.6070e+02,&
        5.3181e+02,5.0785e+02,4.8409e+02,4.6033e+02,4.3657e+02,4.1773e+02,&
        4.0025e+02,3.8278e+02,3.6530e+02,3.4783e+02,3.3199e+02,3.1852e+02,&
        3.0505e+02,2.9158e+02,2.7811e+02,2.6464e+02,2.5207e+02,2.4233e+02,&
        2.3260e+02,2.2286e+02,2.1313e+02,2.0340e+02,1.9366e+02,1.8471e+02,&
        1.7784e+02,1.7096e+02,1.6408e+02,1.5721e+02,1.5033e+02,1.4346e+02,&
        1.3658e+02,1.3110e+02,1.2619e+02,1.2128e+02,1.1637e+02,1.1146e+02,&
        1.0655e+02,1.0164e+02,9.6732e+01,9.3314e+01,8.9973e+01,8.6632e+01,&
        8.3291e+01,7.9950e+01,7.6609e+01,7.3268e+01,6.9927e+01,6.7003e+01,&
        6.4722e+01,6.2441e+01,6.0160e+01,5.7879e+01,5.5597e+01,5.3316e+01,&
        5.1035e+01,4.8754e+01,4.6473e+01,4.4896e+01,4.3453e+01,4.2009e+01,&
        4.0565e+01,3.9122e+01,3.7678e+01,3.6235e+01,3.4791e+01,3.3348e+01,&
        3.1904e+01,3.0460e+01,2.9074e+01,2.8206e+01,2.7338e+01,2.6470e+01,&
        2.5602e+01,2.4734e+01,2.3866e+01,2.2998e+01,2.2130e+01,2.1262e+01,&
        2.0394e+01,1.9526e+01,1.8658e+01,1.7790e+01,1.6922e+01,1.6311e+01,&
        1.5893e+01,1.5474e+01,1.5056e+01,1.4638e+01,1.4219e+01,1.3801e+01,&
        1.3383e+01,1.2964e+01,1.2546e+01,1.2128e+01,1.1709e+01,1.1291e+01,&
        1.0873e+01,1.0454e+01,1.0036e+01,9.6178e+00,9.1995e+00,8.7812e+00,&
        8.3629e+00,8.0893e+00,7.8868e+00,7.6844e+00,7.4819e+00,7.2794e+00,&
        7.0770e+00,6.8745e+00,6.6721e+00,6.4696e+00,6.2672e+00,6.0647e+00,&
        5.8622e+00,5.6598e+00,5.4573e+00,5.2549e+00,5.0524e+00,4.8500e+00,&
        4.6475e+00,4.4450e+00,4.2426e+00,4.0401e+00,3.8377e+00,3.7225e+00,&
        3.6320e+00,3.5415e+00,3.4510e+00,3.3605e+00,3.2700e+00,3.1795e+00,&
        3.0890e+00,2.9985e+00,2.9080e+00,2.8175e+00,2.7270e+00,2.6366e+00,&
        2.5461e+00,2.4556e+00,2.3651e+00,2.2746e+00,2.1841e+00,2.0936e+00,&
        2.0031e+00,1.9126e+00,1.8221e+00,1.7719e+00,1.7267e+00,1.6815e+00,&
        1.6364e+00,1.5912e+00,1.5460e+00,1.5009e+00,1.4557e+00,1.4105e+00,&
        1.3654e+00,1.3202e+00,1.2750e+00,1.2299e+00,1.1847e+00,1.1395e+00,&
        1.0944e+00,1.0492e+00,1.0040e+00,9.8140e-01,9.5931e-01,9.3721e-01,&
        9.1511e-01,8.9302e-01,8.7092e-01,8.4882e-01,8.2673e-01,8.0463e-01,&
        7.8253e-01,7.6044e-01,7.3834e-01,7.1624e-01,6.9415e-01,6.7205e-01,&
        6.5036e-01,6.3549e-01,6.2061e-01,6.0574e-01,5.9087e-01,5.7599e-01,&
        5.6112e-01,5.4624e-01,5.3137e-01,5.1650e-01,5.0162e-01,4.8675e-01,&
        4.7247e-01,4.6269e-01,4.5291e-01,4.4313e-01,4.3335e-01,4.2357e-01,&
        4.1380e-01,4.0402e-01,3.9424e-01,3.8446e-01,3.7506e-01,3.6755e-01,&
        3.6003e-01,3.5252e-01,3.4501e-01,3.3750e-01,3.2998e-01,3.2247e-01,&
        3.1512e-01,3.0837e-01,3.0162e-01,2.9487e-01,2.8812e-01,2.8137e-01,&
        2.7507e-01,2.7026e-01,2.6546e-01,2.6065e-01,2.5584e-01,2.5104e-01,&
        2.4608e-01,2.4070e-01,2.3533e-01,2.2995e-01,2.2494e-01,2.2087e-01,&
        2.1680e-01,2.1273e-01,2.0894e-01,2.0577e-01,2.0261e-01,1.9944e-01,&
        1.9571e-01,1.9078e-01,1.8621e-01,1.8234e-01,1.7875e-01,1.7568e-01,&
        1.7285e-01,1.7044e-01,1.6819e-01,1.6623e-01,1.6166e-01,1.6026e-01,&
        1.5757e-01,1.5421e-01,1.5338e-01,1.5180e-01/)
    HSRA_RHO(:)=(/3.2500e-07,3.2415e-07,3.2326e-07,3.2233e-07,3.2134e-07,&
        3.2100e-07,3.2177e-07,3.2373e-07,3.2681e-07,3.2983e-07,3.3345e-07,&
        3.3536e-07,3.3518e-07,3.3357e-07,3.3058e-07,3.2654e-07,3.2130e-07,&
        3.1560e-07,3.0955e-07,3.0301e-07,2.9577e-07,2.8852e-07,2.8106e-07,&
        2.7360e-07,2.6615e-07,2.5871e-07,2.5126e-07,2.4383e-07,2.3640e-07,&
        2.2897e-07,2.2209e-07,2.1520e-07,2.0837e-07,2.0196e-07,1.9555e-07,&
        1.8917e-07,1.8297e-07,1.7677e-07,1.7061e-07,1.6491e-07,1.5922e-07,&
        1.5355e-07,1.4819e-07,1.4283e-07,1.3751e-07,1.3248e-07,1.2746e-07,&
        1.2251e-07,1.1815e-07,1.1380e-07,1.0949e-07,1.0550e-07,1.0152e-07,&
        9.7583e-08,9.3965e-08,9.0347e-08,8.6756e-08,8.3311e-08,7.9865e-08,&
        7.6629e-08,7.3748e-08,7.0868e-08,6.8018e-08,6.5218e-08,6.2419e-08,&
        5.9770e-08,5.7222e-08,5.4674e-08,5.2388e-08,5.0163e-08,4.7945e-08,&
        4.5971e-08,4.3997e-08,4.2075e-08,4.0316e-08,3.8557e-08,3.6880e-08,&
        3.5301e-08,3.3722e-08,3.2287e-08,3.0923e-08,2.9559e-08,2.8290e-08,&
        2.7034e-08,2.5787e-08,2.4628e-08,2.3468e-08,2.2424e-08,2.1491e-08,&
        2.0557e-08,1.9628e-08,1.8701e-08,1.7797e-08,1.7043e-08,1.6289e-08,&
        1.5573e-08,1.4927e-08,1.4281e-08,1.3629e-08,1.2972e-08,1.2315e-08,&
        1.1733e-08,1.1153e-08,1.0623e-08,1.0171e-08,9.7190e-09,9.2737e-09,&
        8.8331e-09,8.3937e-09,8.0276e-09,7.6615e-09,7.2996e-09,6.9518e-09,&
        6.6039e-09,6.2951e-09,6.0080e-09,5.7209e-09,5.4614e-09,5.2066e-09,&
        4.9536e-09,4.7239e-09,4.4941e-09,4.2716e-09,4.0670e-09,3.8624e-09,&
        3.6668e-09,3.4802e-09,3.2935e-09,3.1253e-09,2.9645e-09,2.8037e-09,&
        2.6571e-09,2.5158e-09,2.3745e-09,2.2447e-09,2.1247e-09,2.0046e-09,&
        1.8846e-09,1.7880e-09,1.6922e-09,1.5965e-09,1.5008e-09,1.4290e-09,&
        1.3639e-09,1.2988e-09,1.2336e-09,1.1685e-09,1.1100e-09,1.0610e-09,&
        1.0121e-09,9.6312e-10,9.1416e-10,8.6521e-10,8.1987e-10,7.8599e-10,&
        7.5211e-10,7.1823e-10,6.8435e-10,6.5046e-10,6.1658e-10,5.8561e-10,&
        5.6234e-10,5.3907e-10,5.1579e-10,4.9252e-10,4.6925e-10,4.4597e-10,&
        4.2270e-10,4.0453e-10,3.8843e-10,3.7232e-10,3.5622e-10,3.4011e-10,&
        3.2400e-10,3.0790e-10,2.9179e-10,2.8078e-10,2.7003e-10,2.5928e-10,&
        2.4853e-10,2.3778e-10,2.2702e-10,2.1627e-10,2.0552e-10,1.9624e-10,&
        1.8923e-10,1.8221e-10,1.7520e-10,1.6819e-10,1.6117e-10,1.5416e-10,&
        1.4714e-10,1.4013e-10,1.3312e-10,1.2836e-10,1.2402e-10,1.1969e-10,&
        1.1535e-10,1.1102e-10,1.0668e-10,1.0235e-10,9.8010e-11,9.3675e-11,&
        8.9340e-11,8.5005e-11,8.0851e-11,7.8346e-11,7.5840e-11,7.3335e-11,&
        7.0829e-11,6.8324e-11,6.5818e-11,6.3313e-11,6.0807e-11,5.8301e-11,&
        5.5796e-11,5.3290e-11,5.0785e-11,4.8279e-11,4.5774e-11,4.4031e-11,&
        4.2860e-11,4.1689e-11,4.0519e-11,3.9348e-11,3.8177e-11,3.7006e-11,&
        3.5835e-11,3.4665e-11,3.3494e-11,3.2323e-11,3.1152e-11,2.9981e-11,&
        2.8811e-11,2.7640e-11,2.6469e-11,2.5298e-11,2.4127e-11,2.2957e-11,&
        2.1786e-11,2.1033e-11,2.0485e-11,1.9937e-11,1.9390e-11,1.8842e-11,&
        1.8294e-11,1.7747e-11,1.7199e-11,1.6651e-11,1.6103e-11,1.5556e-11,&
        1.5008e-11,1.4460e-11,1.3913e-11,1.3365e-11,1.2817e-11,1.2269e-11,&
        1.1722e-11,1.1174e-11,1.0626e-11,1.0079e-11,9.5309e-12,9.2256e-12,&
        8.9890e-12,8.7523e-12,8.5157e-12,8.2791e-12,8.0425e-12,7.8058e-12,&
        7.5692e-12,7.3326e-12,7.0960e-12,6.8593e-12,6.6227e-12,6.3861e-12,&
        6.1495e-12,5.9128e-12,5.6762e-12,5.4396e-12,5.2030e-12,4.9663e-12,&
        4.7297e-12,4.4931e-12,4.2564e-12,4.1278e-12,4.0128e-12,3.8978e-12,&
        3.7828e-12,3.6678e-12,3.5528e-12,3.4378e-12,3.3227e-12,3.2077e-12,&
        3.0927e-12,2.9777e-12,2.8627e-12,2.7477e-12,2.6327e-12,2.5177e-12,&
        2.4026e-12,2.2876e-12,2.1726e-12,2.1160e-12,2.0607e-12,2.0054e-12,&
        1.9502e-12,1.8949e-12,1.8396e-12,1.7843e-12,1.7291e-12,1.6738e-12,&
        1.6185e-12,1.5632e-12,1.5080e-12,1.4527e-12,1.3974e-12,1.3422e-12,&
        1.2880e-12,1.2524e-12,1.2168e-12,1.1812e-12,1.1456e-12,1.1100e-12,&
        1.0744e-12,1.0388e-12,1.0032e-12,9.6765e-13,9.3206e-13,8.9647e-13,&
        8.6227e-13,8.3876e-13,8.1524e-13,7.9173e-13,7.6821e-13,7.4469e-13,&
        7.2118e-13,6.9766e-13,6.7414e-13,6.5063e-13,6.2826e-13,6.1168e-13,&
        5.9509e-13,5.7851e-13,5.6193e-13,5.4535e-13,5.2876e-13,5.1218e-13,&
        4.9598e-13,4.8124e-13,4.6650e-13,4.5176e-13,4.3702e-13,4.2228e-13,&
        4.0892e-13,4.0004e-13,3.9116e-13,3.8228e-13,3.7341e-13,3.6453e-13,&
        3.5521e-13,3.4466e-13,3.3411e-13,3.2355e-13,3.1393e-13,3.0664e-13,&
        2.9936e-13,2.9207e-13,2.8532e-13,2.7979e-13,2.7427e-13,2.6874e-13,&
        2.6223e-13,2.5369e-13,2.4565e-13,2.3862e-13,2.3227e-13,2.2725e-13,&
        2.2258e-13,2.1856e-13,2.1490e-13,2.1189e-13,2.0451e-13,2.0172e-13,&
        1.9711e-13,1.8952e-13,1.8681e-13,1.8100e-13/)
    HSRA_BX(:)=HSRA_TEM*0.
    HSRA_BY(:)=HSRA_TEM*0.
    HSRA_BZ(:)=HSRA_TEM*0.
    HSRA_VZ(:)=HSRA_TEM*0.
    HSRA_Z(:)=(/-82.6000,-77.5751,-72.5503,-67.5254,-62.5005,-57.4756,&
        -52.4508,-47.4259,-42.4010,-37.3762,-32.3513,-27.3264,-22.3016,&
        -17.2767,-12.2518,-7.2269,-2.2021,2.8228,7.8477,12.8725,17.8974,&
        22.9223,27.9472,32.9720,37.9969,43.0218,48.0466,53.0715,58.0964,&
        63.1212,68.1461,73.1710,78.1959,83.2207,88.2456,93.2705,98.2953,&
        103.3202,108.3451,113.3699,118.3948,123.4197,128.4446,133.4694,&
        138.4943,143.5192,148.5440,153.5689,158.5938,163.6187,168.6435,&
        173.6684,178.6933,183.7181,188.7430,193.7679,198.7927,203.8176,&
        208.8425,213.8674,218.8922,223.9171,228.9420,233.9668,238.9917,&
        244.0166,249.0415,254.0663,259.0912,264.1161,269.1409,274.1658,&
        279.1907,284.2155,289.2404,294.2653,299.2902,304.3150,309.3399,&
        314.3648,319.3896,324.4145,329.4394,334.4642,339.4891,344.5140,&
        349.5389,354.5637,359.5886,364.6135,369.6383,374.6632,379.6881,&
        384.7130,389.7378,394.7627,399.7876,404.8124,409.8373,414.8622,&
        419.8870,424.9119,429.9368,434.9617,439.9865,445.0114,450.0363,&
        455.0611,460.0860,465.1109,470.1358,475.1606,480.1855,485.2104,&
        490.2352,495.2601,500.2850,505.3098,510.3347,515.3596,520.3845,&
        525.4093,530.4342,535.4591,540.4839,545.5088,550.5337,555.5586,&
        560.5834,565.6083,570.6332,575.6580,580.6829,585.7078,590.7326,&
        595.7575,600.7824,605.8073,610.8321,615.8570,620.8819,625.9067,&
        630.9316,635.9565,640.9813,646.0062,651.0311,656.0560,661.0808,&
        666.1057,671.1306,676.1554,681.1803,686.2052,691.2301,696.2549,&
        701.2798,706.3047,711.3295,716.3544,721.3793,726.4041,731.4290,&
        736.4539,741.4788,746.5036,751.5285,756.5534,761.5782,766.6031,&
        771.6280,776.6529,781.6777,786.7026,791.7275,796.7523,801.7772,&
        806.8021,811.8269,816.8518,821.8767,826.9016,831.9264,836.9513,&
        841.9762,847.0010,852.0259,857.0508,862.0756,867.1005,872.1254,&
        877.1503,882.1751,887.2000,892.2249,897.2497,902.2746,907.2995,&
        912.3244,917.3492,922.3741,927.3990,932.4238,937.4487,942.4736,&
        947.4984,952.5233,957.5482,962.5731,967.5979,972.6228,977.6477,&
        982.6725,987.6974,992.7223,997.7472,1002.7720,1007.7969,1012.8218,&
        1017.8466,1022.8715,1027.8964,1032.9212,1037.9461,1042.9710,&
        1047.9959,1053.0207,1058.0456,1063.0705,1068.0953,1073.1202,&
        1078.1451,1083.1699,1088.1948,1093.2197,1098.2446,1103.2694,&
        1108.2943,1113.3192,1118.3440,1123.3689,1128.3938,1133.4187,&
        1138.4435,1143.4684,1148.4933,1153.5181,1158.5430,1163.5679,&
        1168.5927,1173.6176,1178.6425,1183.6674,1188.6922,1193.7171,&
        1198.7420,1203.7668,1208.7917,1213.8166,1218.8415,1223.8663,&
        1228.8912,1233.9161,1238.9409,1243.9658,1248.9907,1254.0155,&
        1259.0404,1264.0653,1269.0902,1274.1150,1279.1399,1284.1648,&
        1289.1896,1294.2145,1299.2394,1304.2642,1309.2891,1314.3140,&
        1319.3389,1324.3637,1329.3886,1334.4135,1339.4383,1344.4632,&
        1349.4881,1354.5130,1359.5378,1364.5627,1369.5876,1374.6124,&
        1379.6373,1384.6622,1389.6870,1394.7119,1399.7368,1404.7617,&
        1409.7865,1414.8114,1419.8363,1424.8611,1429.8860,1434.9109,&
        1439.9358,1444.9606,1449.9855,1455.0104,1460.0352,1465.0601,&
        1470.0850,1475.1098,1480.1347,1485.1596,1490.1845,1495.2093,&
        1500.2342,1505.2591,1510.2839,1515.3088,1520.3337,1525.3585,&
        1530.3834,1535.4083,1540.4332,1545.4580,1550.4829,1555.5078,&
        1560.5326,1565.5575,1570.5824,1575.6073,1580.6321,1585.6570,&
        1590.6819,1595.7067,1600.7316,1605.7565,1610.7813,1615.8062,&
        1620.8311,1625.8560,1630.8808,1635.9057,1640.9306,1645.9554,&
        1650.9803,1656.0052,1661.0301,1666.0549,1671.0798,1676.1047,&
        1681.1295,1686.1544,1691.1793,1696.2041,1701.2290,1706.2539,&
        1711.2788,1716.3036,1721.3285,1726.3534,1731.3782,1736.4031,&
        1741.4280,1746.4528,1751.4777,1756.5026,1761.5275,1766.5523,&
        1771.5772,1776.6021,1781.6269,1786.6518,1791.6767,1796.7016,&
        1801.7264,1806.7513,1811.7762,1816.8010,1821.8259,1826.8508,&
        1831.8756,1836.9005,1841.9254,1846.9503,1851.9751,1857.0000/)
    !
  END SUBROUTINE SET_HSRA_MODEL
  !
  !------------------------------------------------
  !
  SUBROUTINE DEALLOCATE_HSRA_MODEL
    !
    DEALLOCATE(HSRA_TEM)
    DEALLOCATE(HSRA_PG)
    DEALLOCATE(HSRA_RHO)
    DEALLOCATE(HSRA_BX)
    DEALLOCATE(HSRA_BY)
    DEALLOCATE(HSRA_BZ)
    DEALLOCATE(HSRA_VZ)
    !
    DEALLOCATE(HSRA_PEL)
    DEALLOCATE(HSRA_MW)
    !
    DEALLOCATE(HSRA_Z)
    !
  END SUBROUTINE DEALLOCATE_HSRA_MODEL
  !
  !------------------------------------------------
  !
  SUBROUTINE HSRA_VARS()
    !
    CALL ALLOCATE_2D_DP(HSRA_ETAI,HSRA_LEN,NUMW,'HSRA_ETAI')
    CALL ALLOCATE_2D_DP(HSRA_ETAQ,HSRA_LEN,NUMW,'HSRA_ETAQ')
    CALL ALLOCATE_2D_DP(HSRA_ETAU,HSRA_LEN,NUMW,'HSRA_ETAU')
    CALL ALLOCATE_2D_DP(HSRA_ETAV,HSRA_LEN,NUMW,'HSRA_ETAV')
    !
    CALL ALLOCATE_2D_DP(HSRA_RHOQ,HSRA_LEN,NUMW,'HSRA_RHOQ')
    CALL ALLOCATE_2D_DP(HSRA_RHOU,HSRA_LEN,NUMW,'HSRA_RHOU')
    CALL ALLOCATE_2D_DP(HSRA_RHOV,HSRA_LEN,NUMW,'HSRA_RHOV')
    !
    CALL ALLOCATE_2D_DP(HSRA_KC,HSRA_LEN,NUMW,'HSRA_RHOV')
    !
    CALL ALLOCATE_2D_DP(HSRA_SYN,4,NUMW,'HSRA_SYN')
    !
  END SUBROUTINE HSRA_VARS
  !
  !------------------------------------------------
  !
  SUBROUTINE DEALLOCATE_HSRA_VARS()
    !
    DEALLOCATE(HSRA_ETAI)
    DEALLOCATE(HSRA_ETAQ)
    DEALLOCATE(HSRA_ETAU)
    DEALLOCATE(HSRA_ETAV)
    !
    DEALLOCATE(HSRA_RHOQ)
    DEALLOCATE(HSRA_RHOU)
    DEALLOCATE(HSRA_RHOV)
    !
    DEALLOCATE(HSRA_KC)
    !
    DEALLOCATE(HSRA_SYN)
    !
  END SUBROUTINE DEALLOCATE_HSRA_VARS
  !
  !------------------------------------------------
  !
  SUBROUTINE GET_ABS_MAT_HSRA (K,L)
    !
    INTEGER,   INTENT(IN)        :: K, L
    !
    HSRA_ETAI(K,PIXEL_INI(L):PIXEL_END(L))=HSRA_KC(K,L)
    HSRA_ETAV(K,PIXEL_INI(L):PIXEL_END(L))=0.D0
    HSRA_ETAQ(K,PIXEL_INI(L):PIXEL_END(L))=0.D0
    HSRA_ETAU(K,PIXEL_INI(L):PIXEL_END(L))=0.D0
    HSRA_RHOV(K,PIXEL_INI(L):PIXEL_END(L))=0.D0
    HSRA_RHOQ(K,PIXEL_INI(L):PIXEL_END(L))=0.D0
    HSRA_RHOU(K,PIXEL_INI(L):PIXEL_END(L))=0.D0
    !
  END SUBROUTINE GET_ABS_MAT_HSRA
  !
  !------------------------------------------------
  !
  SUBROUTINE ANALYTICAL_SOLVER_HSRA(K,L,SYN)
    !
    INTEGER,    INTENT(IN)       :: K,L
    REAL(DP),   INTENT(INOUT)    :: SYN(4)
    REAL(DP), DIMENSION(4,4)     :: EVOL
    REAL(DP), DIMENSION(4)       :: SF
    REAL(DP), DIMENSION(4,1)     :: SFM, IM, IN
    !
    CALL EVOL_OPERATOR_HSRA(K,L,EVOL)
    !
    CALL SOURCE_FUNCTION_HSRA(K,L,SF)
    SFM(:,1)=SF(:)
    !
    IN(:,1)=SYN(:)
    IM=REAL(MATMUL(IMAT-EVOL,SFM)+MATMUL(EVOL,IN))
    !
    SYN(:)=IM(:,1)
    !
  END SUBROUTINE ANALYTICAL_SOLVER_HSRA
  !
  !------------------------------------------------
  !
  SUBROUTINE EVOL_OPERATOR_HSRA(K,L,EVOL)
    !
    INTEGER,   INTENT(IN)                     :: K,L
    REAL(DP), INTENT(INOUT), DIMENSION(4,4)   :: EVOL
    !
    REAL(DP)                                  :: ETA_I, ETA_Q, ETA_U, ETA_V
    REAL(DP)                                  :: RHO_Q, RHO_U, RHO_V
    REAL(DP)                                  :: ETA2, RHO2, ETARHO
    REAL(DP)                                  :: LSIGMA, THETA, RPART, EXPETAI
    REAL(DP)                                  :: LAMBDA1, LAMBDA2
    REAL(DP)                                  :: COSHL1, SINHL1, COSL2, SINL2
    REAL(DP), DIMENSION(4,4)                  :: M1, M2, M3, M4
    LOGICAL                                   :: NAN, CHECKNAN
    !
    REAL(DP)                                  :: DELTAZ
    !
    LOGICAL                                   :: EVOL_IMAT
    !
    M1(:,:)=0.D0
    M2(:,:)=0.D0
    M3(:,:)=0.D0
    M4(:,:)=0.D0
    LSIGMA=0.D0
    !
    ETA_I=DBLE(HSRA_ETAI(K,L))
    ETA_Q=DBLE(HSRA_ETAQ(K,L))
    ETA_U=DBLE(HSRA_ETAU(K,L))
    ETA_V=DBLE(HSRA_ETAV(K,L))
    RHO_Q=DBLE(HSRA_RHOQ(K,L))
    RHO_U=DBLE(HSRA_RHOU(K,L))
    RHO_V=DBLE(HSRA_RHOV(K,L))
    !
    EVOL_IMAT = .FALSE.
    IF (ETA_I.EQ.(ETA_I+1.D0)) EVOL_IMAT = .TRUE.
    IF (ETA_Q.EQ.(ETA_Q+1.D0)) EVOL_IMAT = .TRUE.
    IF (ETA_U.EQ.(ETA_U+1.D0)) EVOL_IMAT = .TRUE.
    IF (ETA_V.EQ.(ETA_V+1.D0)) EVOL_IMAT = .TRUE.
    IF (RHO_Q.EQ.(RHO_Q+1.D0)) EVOL_IMAT = .TRUE.
    IF (RHO_U.EQ.(RHO_U+1.D0)) EVOL_IMAT = .TRUE.
    IF (RHO_V.EQ.(RHO_V+1.D0)) EVOL_IMAT = .TRUE.
    IF (EVOL_IMAT.EQV..TRUE.) THEN
      ETA_I=1.D15
      ETA_Q=1.D15
      ETA_U=1.D15
      ETA_V=1.D15
      RHO_Q=1.D15
      RHO_U=1.D15
      RHO_V=1.D15
    ENDIF
    ! Checking for NaN
    NAN=.FALSE.
    NAN=CHECKNAN(ETA_I)
    NAN=CHECKNAN(ETA_Q)
    NAN=CHECKNAN(ETA_U)
    NAN=CHECKNAN(ETA_V)
    NAN=CHECKNAN(RHO_Q)
    NAN=CHECKNAN(RHO_U)
    NAN=CHECKNAN(RHO_V)
    IF (NAN.EQV..TRUE.) THEN
       PRINT*,'NaN detected in EVOL_OPERATOR'
       STOP
    ENDIF
    !
    ! This part follows Landi Degl'Innocenti & Landi Degl'Innocenti
    ! Solar Physics, 1985, 239-250
    !
    ETA2=ETA_Q**2.D0+ETA_U**2.D0+ETA_V**2.D0
    RHO2=RHO_Q**2.D0+RHO_U**2.D0+RHO_V**2.D0
    ETARHO=ETA_Q*RHO_Q+ETA_U*RHO_U+ETA_V*RHO_V
    RPART=SQRT(((ETA2-RHO2)**2.D0)/4.D0+ETARHO**2.D0)+(ETA2-RHO2)/2.D0
    LAMBDA1=SQRT(RPART)
    !
    RPART=SQRT(((ETA2-RHO2)**2.D0)/4.D0+ETARHO**2.D0)-(ETA2-RHO2)/2.D0
    LAMBDA2=SQRT(RPART)
    IF (ETARHO.GT.0) LSIGMA=1.D0
    IF (ETARHO.LT.0) LSIGMA=-1.D0
    THETA=2.D0*SQRT(((ETA2-RHO2)**2.D0)/4.D0+ETARHO**2.D0)
    !
    ! M1 matrix is the indentiy matrix
    M1=IMAT
    ! M2 matrix
    M2(2,1)=REAL(LAMBDA2*ETA_Q-LSIGMA*LAMBDA1*RHO_Q)
    M2(3,1)=REAL(LAMBDA2*ETA_U-LSIGMA*LAMBDA1*RHO_U)
    M2(4,1)=REAL(LAMBDA2*ETA_V-LSIGMA*LAMBDA1*RHO_V)
    M2(1,2)=REAL(LAMBDA2*ETA_Q-LSIGMA*LAMBDA1*RHO_Q)
    M2(3,2)=REAL(LSIGMA*LAMBDA1*ETA_V+LAMBDA2*RHO_V)
    M2(4,2)=REAL(-LSIGMA*LAMBDA1*ETA_U-LAMBDA2*RHO_U)
    M2(1,3)=REAL(LAMBDA2*ETA_U-LSIGMA*LAMBDA1*RHO_U)
    M2(2,3)=REAL(-LSIGMA*LAMBDA1*ETA_V-LAMBDA2*RHO_V)
    M2(4,3)=REAL(LSIGMA*LAMBDA1*ETA_Q+LAMBDA2*RHO_Q)
    M2(1,4)=REAL(LAMBDA2*ETA_V-LSIGMA*LAMBDA1*RHO_V)
    M2(2,4)=REAL(LSIGMA*LAMBDA1*ETA_U+LAMBDA2*RHO_U)
    M2(3,4)=REAL(-LSIGMA*LAMBDA1*ETA_Q-LAMBDA2*RHO_Q)
    M2(:,:)=REAL(M2(:,:)/THETA)
    ! M3 matrix
    M3(2,1)=REAL(LAMBDA1*ETA_Q+LSIGMA*LAMBDA2*RHO_Q)
    M3(3,1)=REAL(LAMBDA1*ETA_U+LSIGMA*LAMBDA2*RHO_U)
    M3(4,1)=REAL(LAMBDA1*ETA_V+LSIGMA*LAMBDA2*RHO_V)
    M3(1,2)=REAL(LAMBDA1*ETA_Q+LSIGMA*LAMBDA2*RHO_Q)
    M3(3,2)=REAL(-LSIGMA*LAMBDA2*ETA_V+LAMBDA1*RHO_V)
    M3(4,2)=REAL(LSIGMA*LAMBDA2*ETA_U-LAMBDA1*RHO_U)
    M3(1,3)=REAL(LAMBDA1*ETA_U+LSIGMA*LAMBDA2*RHO_U)
    M3(2,3)=REAL(LSIGMA*LAMBDA2*ETA_V-LAMBDA1*RHO_V)
    M3(4,3)=REAL(-LSIGMA*LAMBDA2*ETA_Q+LAMBDA1*RHO_Q)
    M3(1,4)=REAL(LAMBDA1*ETA_V+LSIGMA*LAMBDA2*RHO_V)
    M3(2,4)=REAL(-LSIGMA*LAMBDA2*ETA_U+LAMBDA1*RHO_U)
    M3(3,4)=REAL(LSIGMA*LAMBDA2*ETA_Q-LAMBDA1*RHO_Q)
    M3(:,:)=REAL(M3(:,:)/THETA)
    ! M4 matrix
    M4(1,1)=REAL((ETA2+RHO2)/2.D0)
    M4(2,1)=REAL(ETA_V*RHO_U-ETA_U*RHO_V)
    M4(3,1)=REAL(ETA_Q*RHO_V-ETA_V*RHO_Q)
    M4(4,1)=REAL(ETA_U*RHO_Q-ETA_Q*RHO_U)
    M4(1,2)=REAL(ETA_U*RHO_V-ETA_V*RHO_U)
    M4(2,2)=REAL(ETA_Q**2.D0+RHO_Q**2.D0-(ETA2+RHO2)/2.D0)
    M4(3,2)=REAL(ETA_Q*ETA_U+RHO_Q*RHO_U)
    M4(4,2)=REAL(ETA_V*ETA_Q+RHO_V*RHO_Q)
    M4(1,3)=REAL(ETA_V*RHO_Q-ETA_Q*RHO_V)
    M4(2,3)=REAL(ETA_Q*ETA_U+RHO_Q*RHO_U)
    M4(3,3)=REAL(ETA_U**2.D0+RHO_U**2.D0-(ETA2+RHO2)/2.D0)
    M4(4,3)=REAL(ETA_U*ETA_V+RHO_U*RHO_V)
    M4(1,4)=REAL(ETA_Q*RHO_U-ETA_U*RHO_Q)
    M4(2,4)=REAL(ETA_V*ETA_Q+RHO_V*RHO_Q)
    M4(3,4)=REAL(ETA_U*ETA_V+RHO_U*RHO_V)
    M4(4,4)=REAL(ETA_V**2.D0+RHO_V**2.D0-(ETA2+RHO2)/2.D0)
    M4(:,:)=REAL(2.D0*M4(:,:)/THETA)
    !
    IF (K.EQ.HSRA_LEN) THEN
      DELTAZ=1D5*ABS(HSRA_Z(K)-HSRA_Z(K-1))
    ELSE
      DELTAZ=1D5*ABS(HSRA_Z(K+1)-HSRA_Z(K))
    ENDIF
    !
    IF (THETA.EQ.0) THEN
      M2(:,:)=0.D0
      M3(:,:)=0.D0
      M4(:,:)=0.D0
    ENDIF
    !
    ! Multiplicative factors
    COSHL1=COSH(LAMBDA1*DELTAZ)
    SINHL1=SINH(LAMBDA1*DELTAZ)
    ! FOR GIVEN COMBINATIONS OF T, PG, AND RHO SINHL1 AND COSHL1 MIGHT BECOME
    ! EXTREMELY HUGE, INFINITY FOR PRACTICAL PURPOSES. EVENTUALLY, THIS GIVES RISE 
    ! TO NaN. TO AVOID SUCH SITUATION, WE LIMIT THE LARGEST VALUES OF BOTH COSHL1
    ! AND SINHL1. THIS HAS NO UNEXPECTED INFLUENCE ON THE CODE PERFORMANCE BECAUSE
    ! FOR LARGE ENOUGH COSHL1 AND SINHL1, EVOL BECOMES 0
    IF (COSHL1.EQ.(COSHL1+1.D0)) COSHL1=1.D15
    IF (SINHL1.EQ.(SINHL1+1.D0)) SINHL1=1.D15
    !WRITE(*,*) COSHL1, SINHL1
    !
    COSL2=COS(LAMBDA2*DELTAZ)
    SINL2=SIN(LAMBDA2*DELTAZ)
    EXPETAI=EXP(-ETA_I*DELTAZ)
    !
    ! Evolution operator
    EVOL=EXPETAI*(0.5D0*(COSHL1+COSL2)*M1-SINL2*M2&
        -SINHL1*M3+0.5D0*(COSHL1-COSL2)*M4)
    IF (EVOL_IMAT.EQV..TRUE.) EVOL=IMAT
    !
  END SUBROUTINE EVOL_OPERATOR_HSRA
  !
  !------------------------------------------------
  !
  SUBROUTINE SOURCE_FUNCTION_HSRA(K,L,SYN)
    !
    IMPLICIT NONE
    !
    INTEGER,    INTENT(IN)                  :: K, L
    REAL(DP), INTENT(INOUT), DIMENSION(4)   :: SYN
    INTEGER                                 :: M
    REAL(DP)                                :: WAVELENGTH
    !
    WAVELENGTH=0.D0
    !
    DO M=1,NUML
       IF (L.GE.PIXEL_INI(M).AND.M.LE.PIXEL_END(M)) WAVELENGTH&
           =LINE_L0(IND_LINE(M))+WAVE(L)/1D3
    ENDDO
    ! cm !
    WAVELENGTH=WAVELENGTH*1D-8
    ! We assume black body radiation (LTE) and no polarization for the 
    ! source function
    SYN(:)=0.D0
    SYN(1)=REAL(2.D0*HPLA*LIGHT**2.D0/(WAVELENGTH**5.D0)&
        *(1.D0/(EXP(HPLA*LIGHT/(WAVELENGTH*KBOL*HSRA_TEM(K)))-1.D0)))
    !
  END SUBROUTINE SOURCE_FUNCTION_HSRA
  !
  !------------------------------------------------
  !
  SUBROUTINE SET_BOUNDARY_HSRA(K,L,SYN)
    !
    INTEGER,    INTENT(IN)                  :: K, L
    REAL(DP), DIMENSION(4), INTENT(INOUT)   :: SYN
    ! At the lower boundary we assume the emergent radiation is the 
    ! source function
    CALL SOURCE_FUNCTION_HSRA(K,L,SYN)
    !
  END SUBROUTINE SET_BOUNDARY_HSRA
  !
  !------------------------------------------------
  !
  SUBROUTINE GET_NORM(HSRA,GAIN)
    !
    USE CONT_OPACITY, ONLY: OPAC_CONTINUUM
    !
    LOGICAL, INTENT(IN)              :: HSRA
    REAL(SP), INTENT(INOUT)          :: GAIN(4,NUMW)
    !
    INTEGER                          :: K, L
    REAL(DP)                         :: NHYD, NELEC
    !
    IF (HSRA.EQV..TRUE.) THEN 
      !
      CALL HSRA_VARS()
      CALL SET_HSRA_MODEL()
      !
      DO K=1,HSRA_LEN
         !
         CALL GET_NHNEMU_G(HSRA_TEM(K),HSRA_PG(K),HSRA_RHO(K),NHYD,NELEC&
             ,HSRA_MW(K),HSRA_PEL(K))
         !
         !
         DO L=1,NUML
            !
            CALL OPAC_CONTINUUM(HSRA_TEM(K),LINE_L0(IND_LINE(L)),NELEC&
                 ,NHYD,HSRA_KC(K,L))
            !
            CALL GET_ABS_MAT_HSRA(K,L)
            !
         ENDDO
         !
         DO L=1,NUMW
            !
            IF (K.EQ.1) THEN
               CALL SET_BOUNDARY_HSRA(K,L,HSRA_SYN(:,L))
            ELSE
               CALL ANALYTICAL_SOLVER_HSRA(K,L,HSRA_SYN(:,L))
            ENDIF
            !
         ENDDO
         !
      ENDDO
      !
      GAIN(1,:)=REAL(1.D0/HSRA_SYN(1,:))
      GAIN(2,:)=GAIN(1,:)
      GAIN(3,:)=GAIN(1,:)
      GAIN(4,:)=GAIN(1,:)
      ! Landi's reference frame defines positive Vdifferently to the standard
      GAIN(4,:)=-GAIN(1,:)   
      !
      CALL DEALLOCATE_HSRA_VARS()
      !
    ELSE
      !
      GAIN(:,:)=GAIN(:,:)*0.E0+1.E0
      ! Landi's reference frame defines positive Vdifferently to the standard
      GAIN(4,:)=-GAIN(1,:)   
    ENDIF
  !
  END SUBROUTINE GET_NORM
  !
  !================================================
  !
END MODULE NORMALIZATION
!
